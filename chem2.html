<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全屏有机化合物拼图系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 重置所有默认样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* 确保html和body占据100%高度 */
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #0a192f;
            color: #e6f1ff;
        }
        
        /* 主容器 - 100%全屏 */
        #app-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* 头部区域 */
        .header {
            background-color: #112240;
            padding: 12px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #64ffda;
            flex-shrink: 0;
            height: 70px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            color: #64ffda;
            font-size: 1.8rem;
        }
        
        .logo-text h1 {
            font-size: 1.6rem;
            background: linear-gradient(90deg, #64ffda, #57cbff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .logo-text p {
            font-size: 0.85rem;
            color: #8892b0;
        }
        
        .header-controls {
            display: flex;
            gap: 12px;
        }
        
        .control-btn {
            background-color: #233554;
            color: #ccd6f6;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .control-btn:hover {
            background-color: #3a506b;
            transform: translateY(-2px);
        }
        
        .primary-btn {
            background-color: #0a7c71;
            color: white;
        }
        
        .primary-btn:hover {
            background-color: #0d9b8d;
        }
        
        .danger-btn {
            background-color: #ff6b6b;
            color: white;
        }
        
        .danger-btn:hover {
            background-color: #ff5252;
        }
        
        /* 主内容区域 - 占据剩余所有空间 */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            padding: 15px;
            gap: 15px;
        }
        
        /* 左侧面板 */
        .left-panel {
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-shrink: 0;
        }
        
        .panel {
            background-color: #112240;
            border-radius: 8px;
            padding: 18px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
            max-height: 100%;
        }
        
        .panel-title {
            font-size: 1.2rem;
            color: #64ffda;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #233554;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-title i {
            font-size: 1.1rem;
        }
        
        /* 工作区 - 占据中间所有空间 */
        .workspace-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #112240;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .workspace-header {
            padding: 12px 20px;
            background-color: #0d1b2a;
            border-bottom: 1px solid #233554;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .workspace-title {
            font-size: 1.2rem;
            color: #ccd6f6;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-color: #0a192f;
            cursor: grab;
            user-select: none;
            touch-action: none;
        }
        
        .canvas-container.dragging {
            cursor: grabbing;
        }
        
        .canvas-container.add-mode {
            cursor: crosshair;
        }
        
        .canvas-container.connect-mode {
            cursor: pointer;
        }
        
        .canvas-container.delete-mode {
            cursor: not-allowed;
        }
        
        #molecule-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        /* 原子网格 */
        .atom-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .atom-item {
            background-color: #1d3657;
            border-radius: 8px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            user-select: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .atom-item:hover {
            transform: translateY(-3px);
            border-color: #64ffda;
            box-shadow: 0 6px 12px rgba(100, 255, 218, 0.2);
        }
        
        .atom-item.selected {
            border-color: #64ffda;
            background-color: #233554;
            box-shadow: 0 6px 12px rgba(100, 255, 218, 0.3);
        }
        
        .atom-symbol {
            font-size: 1.6rem;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .atom-name {
            font-size: 0.8rem;
            color: #8892b0;
        }
        
        .carbon { color: #50fa7b; }
        .hydrogen { color: #ff79c6; }
        .oxygen { color: #ff5555; }
        .nitrogen { color: #8be9fd; }
        .sulfur { color: #f1fa8c; }
        .phosphorus { color: #bd93f9; }
        .chlorine { color: #50fa7b; }
        .fluorine { color: #8be9fd; }
        .bromine { color: #ffb86c; }
        .iodine { color: #bd93f9; }
        
        /* 化学键网格 */
        .bond-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .bond-item {
            background-color: #1d3657;
            border-radius: 8px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .bond-item:hover {
            transform: translateY(-3px);
            border-color: #64ffda;
            box-shadow: 0 6px 12px rgba(100, 255, 218, 0.2);
        }
        
        .bond-item.selected {
            border-color: #64ffda;
            background-color: #233554;
            box-shadow: 0 6px 12px rgba(100, 255, 218, 0.3);
        }
        
        .bond-type {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 4px;
            color: #64ffda;
        }
        
        /* 官能团网格 */
        .functional-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .functional-item {
            background-color: #1d3657;
            border-radius: 8px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            user-select: none;
        }
        
        .functional-item:hover {
            transform: translateY(-3px);
            border-color: #ffb86c;
            box-shadow: 0 6px 12px rgba(255, 184, 108, 0.2);
        }
        
        .functional-item.selected {
            border-color: #ffb86c;
            background-color: #2a3f62;
            box-shadow: 0 6px 12px rgba(255, 184, 108, 0.3);
        }
        
        .functional-icon {
            font-size: 1.4rem;
            margin-bottom: 6px;
            color: #ffb86c;
        }
        
        .functional-name {
            font-size: 0.85rem;
            color: #ccd6f6;
        }
        
        /* 右侧信息面板 */
        .info-panel {
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-shrink: 0;
        }
        
        .molecule-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .info-box {
            background-color: #1d3657;
            border-radius: 8px;
            padding: 18px;
        }
        
        .info-box-title {
            font-size: 1rem;
            color: #64ffda;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .compound-name-display {
            font-size: 1.6rem;
            color: #f8f8f2;
            margin-bottom: 8px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .compound-formula-display {
            font-size: 1.2rem;
            color: #ffb86c;
            text-align: center;
            margin-bottom: 12px;
            font-weight: 600;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #233554;
        }
        
        .detail-item:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            color: #8892b0;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .detail-value {
            color: #ccd6f6;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .history-panel {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .history-item {
            background-color: #233554;
            border-radius: 6px;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid #64ffda;
        }
        
        .history-item:hover {
            background-color: #2a3f62;
            transform: translateX(3px);
        }
        
        .history-name {
            font-weight: 600;
            color: #f8f8f2;
            margin-bottom: 4px;
            font-size: 0.95rem;
        }
        
        .history-formula {
            font-size: 0.85rem;
            color: #8892b0;
        }
        
        /* 光标信息 */
        .cursor-info {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background-color: rgba(17, 34, 64, 0.9);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #ccd6f6;
            border: 1px solid #233554;
            z-index: 5;
            pointer-events: none;
        }
        
        /* 模式指示器 */
        .mode-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: rgba(17, 34, 64, 0.9);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #64ffda;
            border: 1px solid #64ffda;
            z-index: 5;
            display: flex;
            align-items: center;
            gap: 8px;
            pointer-events: none;
        }
        
        /* 缩放控制 */
        .zoom-controls {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background-color: rgba(17, 34, 64, 0.9);
            border-radius: 6px;
            border: 1px solid #233554;
            z-index: 5;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .zoom-btn {
            background-color: transparent;
            color: #ccd6f6;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .zoom-btn:hover {
            background-color: rgba(100, 255, 218, 0.1);
        }
        
        .zoom-btn:disabled {
            color: #8892b0;
            cursor: not-allowed;
        }
        
        .zoom-btn:disabled:hover {
            background-color: transparent;
        }
        
        .zoom-divider {
            height: 1px;
            background-color: #233554;
        }
        
        .zoom-display {
            position: absolute;
            bottom: 70px;
            right: 15px;
            background-color: rgba(17, 34, 64, 0.9);
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            color: #64ffda;
            border: 1px solid #233554;
            z-index: 5;
            pointer-events: none;
        }
        
        /* 操作按钮区域 */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .action-btn {
            flex: 1;
            background-color: #233554;
            color: #ccd6f6;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .action-btn:hover {
            background-color: #3a506b;
        }
        
        .action-btn.selected {
            background-color: #0a7c71;
            color: white;
        }
        
        /* 原子属性显示 */
        .atom-properties {
            margin-top: 15px;
            padding: 12px;
            background-color: #1d3657;
            border-radius: 6px;
            border: 1px solid #233554;
        }
        
        .atom-prop-title {
            color: #64ffda;
            margin-bottom: 8px;
            font-size: 1rem;
        }
        
        .atom-prop-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .atom-prop-label {
            color: #8892b0;
            font-size: 0.85rem;
        }
        
        .atom-prop-value {
            color: #ccd6f6;
            font-size: 0.85rem;
        }
        
        /* 通知 */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #1d3657;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
            border-left: 5px solid #64ffda;
            max-width: 300px;
        }
        
        .notification.show {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #0a192f;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #233554;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #3a506b;
        }
        
        /* 响应式调整 */
        @media (max-width: 1200px) {
            .left-panel, .info-panel {
                width: 260px;
            }
            
            .atom-grid, .bond-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-height: 700px) {
            .header {
                height: 60px;
                padding: 10px 20px;
            }
            
            .panel {
                padding: 12px;
            }
            
            .panel-title {
                font-size: 1.1rem;
                margin-bottom: 12px;
            }
            
            .atom-grid, .bond-grid, .functional-grid {
                gap: 8px;
            }
            
            .atom-item, .bond-item, .functional-item {
                padding: 10px 6px;
            }
            
            .atom-symbol {
                font-size: 1.4rem;
            }
            
            .bond-type {
                font-size: 1.1rem;
            }
            
            .functional-icon {
                font-size: 1.2rem;
            }
        }
        
        /* 工作区控制按钮 */
        .workspace-controls {
            display: flex;
            gap: 10px;
        }
        
        /* 示例列表 */
        .examples {
            margin-top: 15px;
        }
        
        .example-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .example-item {
            background-color: #233554;
            border-radius: 6px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .example-item:hover {
            background-color: #2a3f62;
            transform: translateY(-2px);
        }
        
        /* 画布网格背景 */
        .canvas-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(100, 255, 218, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(100, 255, 218, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
        }
        
        /* 确保canvas在网格上方 */
        #molecule-canvas {
            position: relative;
            z-index: 1;
        }
        
        /* 选中框 */
        .selection-box {
            position: absolute;
            border: 2px dashed #64ffda;
            background-color: rgba(100, 255, 218, 0.1);
            pointer-events: none;
            z-index: 2;
        }
        
        /* 拖拽中原子样式 */
        .dragging-atom {
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- 头部 -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-atom"></i>
                </div>
                <div class="logo-text">
                    <h1>有机化合物拼图系统</h1>
                    <p>全屏分子构建与IUPAC标准命名</p>
                </div>
            </div>
            <div class="header-controls">
                <button class="control-btn" id="export-btn">
                    <i class="fas fa-download"></i> 导出
                </button>
                <button class="control-btn primary-btn" id="name-btn">
                    <i class="fas fa-spell-check"></i> 生成名称
                </button>
                <button class="control-btn" id="hint-btn">
                    <i class="fas fa-lightbulb"></i> 提示
                </button>
                <button class="control-btn danger-btn" id="clear-btn">
                    <i class="fas fa-trash-alt"></i> 清除
                </button>
            </div>
        </div>
        
        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 左侧面板 -->
            <div class="left-panel">
                <div class="panel">
                    <h3 class="panel-title"><i class="fas fa-shapes"></i> 原子与化学键</h3>
                    <div class="atom-grid">
                        <div class="atom-item carbon selected" data-atom="C">
                            <div class="atom-symbol carbon">C</div>
                            <div class="atom-name">碳</div>
                        </div>
                        <div class="atom-item hydrogen" data-atom="H">
                            <div class="atom-symbol hydrogen">H</div>
                            <div class="atom-name">氢</div>
                        </div>
                        <div class="atom-item oxygen" data-atom="O">
                            <div class="atom-symbol oxygen">O</div>
                            <div class="atom-name">氧</div>
                        </div>
                        <div class="atom-item nitrogen" data-atom="N">
                            <div class="atom-symbol nitrogen">N</div>
                            <div class="atom-name">氮</div>
                        </div>
                        <div class="atom-item sulfur" data-atom="S">
                            <div class="atom-symbol sulfur">S</div>
                            <div class="atom-name">硫</div>
                        </div>
                        <div class="atom-item chlorine" data-atom="Cl">
                            <div class="atom-symbol chlorine">Cl</div>
                            <div class="atom-name">氯</div>
                        </div>
                        <div class="atom-item fluorine" data-atom="F">
                            <div class="atom-symbol fluorine">F</div>
                            <div class="atom-name">氟</div>
                        </div>
                        <div class="atom-item bromine" data-atom="Br">
                            <div class="atom-symbol bromine">Br</div>
                            <div class="atom-name">溴</div>
                        </div>
                        <div class="atom-item iodine" data-atom="I">
                            <div class="atom-symbol iodine">I</div>
                            <div class="atom-name">碘</div>
                        </div>
                    </div>
                    
                    <div class="atom-properties" id="atom-properties">
                        <div class="atom-prop-title">原子属性</div>
                        <div class="atom-prop-item">
                            <span class="atom-prop-label">价键数:</span>
                            <span class="atom-prop-value" id="atom-valence">4</span>
                        </div>
                        <div class="atom-prop-item">
                            <span class="atom-prop-label">原子量:</span>
                            <span class="atom-prop-value" id="atom-mass">12.01</span>
                        </div>
                        <div class="atom-prop-item">
                            <span class="atom-prop-label">电负性:</span>
                            <span class="atom-prop-value" id="atom-electronegativity">2.55</span>
                        </div>
                    </div>
                    
                    <h3 class="panel-title"><i class="fas fa-link"></i> 化学键类型</h3>
                    <div class="bond-grid">
                        <div class="bond-item selected" data-bond="single">
                            <div class="bond-type">—</div>
                            <div class="atom-name">单键</div>
                        </div>
                        <div class="bond-item" data-bond="double">
                            <div class="bond-type">=</div>
                            <div class="atom-name">双键</div>
                        </div>
                        <div class="bond-item" data-bond="triple">
                            <div class="bond-type">≡</div>
                            <div class="atom-name">三键</div>
                        </div>
                        <div class="bond-item" data-bond="wedge">
                            <div class="bond-type">▲</div>
                            <div class="atom-name">实楔键</div>
                        </div>
                        <div class="bond-item" data-bond="dash">
                            <div class="bond-type">△</div>
                            <div class="atom-name">虚楔键</div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn selected" id="add-atom-btn">
                            <i class="fas fa-plus-circle"></i> 添加原子
                        </button>
                        <button class="action-btn" id="connect-atoms-btn">
                            <i class="fas fa-link"></i> 连接原子
                        </button>
                        <button class="action-btn" id="delete-btn">
                            <i class="fas fa-trash"></i> 删除模式
                        </button>
                        <button class="action-btn" id="drag-btn">
                            <i class="fas fa-arrows-alt"></i> 拖拽模式
                        </button>
                    </div>
                </div>
                
                <div class="panel">
                    <h3 class="panel-title"><i class="fas fa-star-of-life"></i> 常见官能团</h3>
                    <div class="functional-grid">
                        <div class="functional-item" data-functional="hydroxyl">
                            <div class="functional-icon">—OH</div>
                            <div class="functional-name">羟基</div>
                        </div>
                        <div class="functional-item" data-functional="carbonyl">
                            <div class="functional-icon">C=O</div>
                            <div class="functional-name">羰基</div>
                        </div>
                        <div class="functional-item" data-functional="carboxyl">
                            <div class="functional-icon">—COOH</div>
                            <div class="functional-name">羧基</div>
                        </div>
                        <div class="functional-item" data-functional="amino">
                            <div class="functional-icon">—NH₂</div>
                            <div class="functional-name">氨基</div>
                        </div>
                        <div class="functional-item" data-functional="aldehyde">
                            <div class="functional-icon">—CHO</div>
                            <div class="functional-name">醛基</div>
                        </div>
                        <div class="functional-item" data-functional="ester">
                            <div class="functional-icon">—COO—</div>
                            <div class="functional-name">酯基</div>
                        </div>
                        <div class="functional-item" data-functional="ether">
                            <div class="functional-icon">—O—</div>
                            <div class="functional-name">醚键</div>
                        </div>
                        <div class="functional-item" data-functional="amide">
                            <div class="functional-icon">—CONH₂</div>
                            <div class="functional-name">酰胺基</div>
                        </div>
                        <div class="functional-item" data-functional="phenyl">
                            <div class="functional-icon">C₆H₅—</div>
                            <div class="functional-name">苯基</div>
                        </div>
                        <div class="functional-item" data-functional="nitro">
                            <div class="functional-icon">—NO₂</div>
                            <div class="functional-name">硝基</div>
                        </div>
                        <div class="functional-item" data-functional="sulfhydryl">
                            <div class="functional-icon">—SH</div>
                            <div class="functional-name">巯基</div>
                        </div>
                        <div class="functional-item" data-functional="methyl">
                            <div class="functional-icon">—CH₃</div>
                            <div class="functional-name">甲基</div>
                        </div>
                    </div>
                </div>
                
                <div class="panel examples">
                    <h3 class="panel-title"><i class="fas fa-vial"></i> 示例化合物</h3>
                    <div class="example-list">
                        <div class="example-item" data-example="methane">甲烷</div>
                        <div class="example-item" data-example="ethane">乙烷</div>
                        <div class="example-item" data-example="ethene">乙烯</div>
                        <div class="example-item" data-example="ethanol">乙醇</div>
                        <div class="example-item" data-example="benzene">苯</div>
                        <div class="example-item" data-example="toluene">甲苯</div>
                        <div class="example-item" data-example="tnt">TNT</div>
                        <div class="example-item" data-example="acetic_acid">乙酸</div>
                        <div class="example-item" data-example="cyclobutane">环丁烷</div>
                        <div class="example-item" data-example="cyclohexane">环己烷</div>
                        <div class="example-item" data-example="c2f2br2">C₂F₂Br₂</div>
                        <div class="example-item" data-example="acetylene">乙炔</div>
                        <div class="example-item" data-example="propene">丙烯</div>
                        <div class="example-item" data-example="hydroxypropene">2-羟基丙烯</div>
                    </div>
                </div>
            </div>
            
            <!-- 中间工作区 -->
            <div class="workspace-area">
                <div class="workspace-header">
                    <div class="workspace-title">
                        <i class="fas fa-flask"></i> 分子构建区
                    </div>
                    <div class="workspace-controls">
                        <button class="control-btn" id="rotate-btn">
                            <i class="fas fa-sync-alt"></i> 旋转
                        </button>
                        <button class="control-btn" id="random-btn">
                            <i class="fas fa-random"></i> 随机示例
                        </button>
                        <button class="control-btn" id="reset-view-btn">
                            <i class="fas fa-expand-alt"></i> 重置视图
                        </button>
                    </div>
                </div>
                <div class="canvas-container" id="canvas-container">
                    <canvas id="molecule-canvas"></canvas>
                    <div class="cursor-info" id="cursor-info">点击空白处添加碳原子</div>
                    <div class="mode-indicator" id="mode-indicator">模式：添加原子</div>
                    <div class="zoom-display" id="zoom-display">缩放: 100%</div>
                    <div class="zoom-controls" id="zoom-controls">
                        <button class="zoom-btn" id="zoom-in-btn" title="放大">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <div class="zoom-divider"></div>
                        <button class="zoom-btn" id="zoom-out-btn" title="缩小">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <div class="zoom-divider"></div>
                        <button class="zoom-btn" id="zoom-reset-btn" title="重置缩放">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 右侧信息面板 -->
            <div class="info-panel">
                <div class="panel">
                    <h3 class="panel-title"><i class="fas fa-info-circle"></i> 化合物信息</h3>
                    <div class="molecule-info">
                        <div class="info-box">
                            <div class="compound-name-display" id="compound-name">未命名化合物</div>
                            <div class="compound-formula-display" id="compound-formula">C?H?</div>
                            <div class="detail-item">
                                <span class="detail-label">IUPAC名称:</span>
                                <span class="detail-value" id="iupac-name">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">分子式:</span>
                                <span class="detail-value" id="molecular-formula">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">分子量:</span>
                                <span class="detail-value" id="molecular-weight">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">不饱和度:</span>
                                <span class="detail-value" id="unsaturation-index">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">原子数:</span>
                                <span class="detail-value" id="atom-count">0</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">缩放级别:</span>
                                <span class="detail-value" id="zoom-level">100%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="panel history-panel">
                    <h3 class="panel-title"><i class="fas fa-history"></i> 历史记录</h3>
                    <div class="history-list" id="history-list">
                        <div class="history-item" data-example="methane">
                            <div class="history-name">甲烷</div>
                            <div class="history-formula">CH₄</div>
                        </div>
                        <div class="history-item" data-example="ethane">
                            <div class="history-name">乙烷</div>
                            <div class="history-formula">C₂H₆</div>
                        </div>
                        <div class="history-item" data-example="ethene">
                            <div class="history-name">乙烯</div>
                            <div class="history-formula">C₂H₄</div>
                        </div>
                        <div class="history-item" data-example="ethanol">
                            <div class="history-name">乙醇</div>
                            <div class="history-formula">C₂H₅OH</div>
                        </div>
                        <div class="history-item" data-example="benzene">
                            <div class="history-name">苯</div>
                            <div class="history-formula">C₆H₆</div>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <h3 class="panel-title"><i class="fas fa-graduation-cap"></i> 使用说明</h3>
                    <div style="font-size: 0.9rem; color: #8892b0; line-height: 1.5;">
                        <p>1. 选择原子，点击画布添加</p>
                        <p>2. 选择化学键，点击两个原子连接</p>
                        <p>3. 切换操作模式：添加/连接/删除/拖拽</p>
                        <p>4. 点击官能团快速添加复杂结构</p>
                        <p>5. 点击示例化合物快速构建</p>
                        <p>6. 使用鼠标滚轮或按钮缩放画布</p>
                        <p>7. 在拖拽模式下拖动原子或画布</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 通知 -->
    <div class="notification" id="notification">
        <div id="notification-content">欢迎使用全屏有机化合物拼图系统！</div>
    </div>

    <script>
        // 等待DOM完全加载
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化所有变量
            let atoms = [];
            let bonds = [];
            let selectedAtom = null;
            let selectedBondType = 'single';
            let selectedAtomType = 'C';
            let currentMode = 'add'; // add, connect, delete, drag
            let atomIdCounter = 1;
            let bondIdCounter = 1;
            let moleculeRotation = 0;
            let isRotating = false;
            
            // 拖拽和缩放相关变量
            let isDragging = false;
            let isDraggingAtom = false;
            let dragStartX = 0;
            let dragStartY = 0;
            let initialAtomPositions = [];
            let scale = 1;
            let offsetX = 0;
            let offsetY = 0;
            let minScale = 0.1;
            let maxScale = 5;
            
            // 获取DOM元素
            const canvas = document.getElementById('molecule-canvas');
            const ctx = canvas.getContext('2d');
            const cursorInfo = document.getElementById('cursor-info');
            const modeIndicator = document.getElementById('mode-indicator');
            const notification = document.getElementById('notification');
            const canvasContainer = document.getElementById('canvas-container');
            const zoomDisplay = document.getElementById('zoom-display');
            const zoomLevel = document.getElementById('zoom-level');
            
            // 原子属性
            const atomProperties = {
                'C': { name: '碳', valence: 4, radius: 20, color: '#50fa7b', mass: 12.01, electronegativity: 2.55 },
                'H': { name: '氢', valence: 1, radius: 15, color: '#ff79c6', mass: 1.01, electronegativity: 2.20 },
                'O': { name: '氧', valence: 2, radius: 18, color: '#ff5555', mass: 16.00, electronegativity: 3.44 },
                'N': { name: '氮', valence: 3, radius: 18, color: '#8be9fd', mass: 14.01, electronegativity: 3.04 },
                'S': { name: '硫', valence: 2, radius: 19, color: '#f1fa8c', mass: 32.07, electronegativity: 2.58 },
                'Cl': { name: '氯', valence: 1, radius: 19, color: '#50fa7b', mass: 35.45, electronegativity: 3.16 },
                'F': { name: '氟', valence: 1, radius: 16, color: '#8be9fd', mass: 19.00, electronegativity: 3.98 },
                'Br': { name: '溴', valence: 1, radius: 21, color: '#ffb86c', mass: 79.90, electronegativity: 2.96 },
                'I': { name: '碘', valence: 1, radius: 23, color: '#bd93f9', mass: 126.90, electronegativity: 2.66 }
            };
            
            // 化学键属性
            const bondProperties = {
                'single': { name: '单键', width: 3, dash: [] },
                'double': { name: '双键', width: 3, dash: [] },
                'triple': { name: '三键', width: 3, dash: [] },
                'wedge': { name: '实楔键', width: 4, dash: [] },
                'dash': { name: '虚楔键', width: 3, dash: [5, 5] }
            };
            
            // 官能团定义
            const functionalGroups = {
                'hydroxyl': {
                    name: '羟基',
                    atoms: [
                        { type: 'O', x: 0, y: 0 },
                        { type: 'H', x: 45, y: 0 }
                    ],
                    bonds: [
                        { atom1Index: 0, atom2Index: 1, type: 'single' }
                    ]
                },
                'carbonyl': {
                    name: '羰基',
                    atoms: [
                        { type: 'C', x: 0, y: 0 },
                        { type: 'O', x: 60, y: 0 }
                    ],
                    bonds: [
                        { atom1Index: 0, atom2Index: 1, type: 'double' }
                    ]
                },
                'carboxyl': {
                    name: '羧基',
                    atoms: [
                        { type: 'C', x: 0, y: 0 },
                        { type: 'O', x: 60, y: -25 },
                        { type: 'O', x: 60, y: 25 },
                        { type: 'H', x: 100, y: 25 }
                    ],
                    bonds: [
                        { atom1Index: 0, atom2Index: 1, type: 'double' },
                        { atom1Index: 0, atom2Index: 2, type: 'single' },
                        { atom1Index: 2, atom2Index: 3, type: 'single' }
                    ]
                },
                'amino': {
                    name: '氨基',
                    atoms: [
                        { type: 'N', x: 0, y: 0 },
                        { type: 'H', x: 40, y: -25 },
                        { type: 'H', x: 40, y: 25 }
                    ],
                    bonds: [
                        { atom1Index: 0, atom2Index: 1, type: 'single' },
                        { atom1Index: 0, atom2Index: 2, type: 'single' }
                    ]
                },
                'aldehyde': {
                    name: '醛基',
                    atoms: [
                        { type: 'C', x: 0, y: 0 },
                        { type: 'O', x: 60, y: 0 },
                        { type: 'H', x: -40, y: 0 }
                    ],
                    bonds: [
                        { atom1Index: 0, atom2Index: 1, type: 'double' },
                        { atom1Index: 0, atom2Index: 2, type: 'single' }
                    ]
                },
                'ester': {
                    name: '酯基',
                    atoms: [
                        { type: 'C', x: 0, y: 0 },
                        { type: 'O', x: 60, y: 0 },
                        { type: 'O', x: -40, y: 0 },
                        { type: 'C', x: -80, y: 0 }
                    ],
                    bonds: [
                        { atom1Index: 0, atom2Index: 1, type: 'double' },
                        { atom1Index: 0, atom2Index: 2, type: 'single' },
                        { atom1Index: 2, atom2Index: 3, type: 'single' }
                    ]
                },
                'ether': {
                    name: '醚键',
                    atoms: [
                        { type: 'O', x: 0, y: 0 },
                        { type: 'C', x: 45, y: -45 },
                        { type: 'C', x: 45, y: 45 }
                    ],
                    bonds: [
                        { atom1Index: 0, atom2Index: 1, type: 'single' },
                        { atom1Index: 0, atom2Index: 2, type: 'single' }
                    ]
                },
                'amide': {
                    name: '酰胺基',
                    atoms: [
                        { type: 'C', x: 0, y: 0 },
                        { type: 'O', x: 60, y: 0 },
                        { type: 'N', x: -40, y: 0 },
                        { type: 'H', x: -70, y: -25 },
                        { type: 'H', x: -70, y: 25 }
                    ],
                    bonds: [
                        { atom1Index: 0, atom2Index: 1, type: 'double' },
                        { atom1Index: 0, atom2Index: 2, type: 'single' },
                        { atom1Index: 2, atom2Index: 3, type: 'single' },
                        { atom1Index: 2, atom2Index: 4, type: 'single' }
                    ]
                },
                'phenyl': {
                    name: '苯基',
                    atoms: [
                        { type: 'C', x: 0, y: -80 },
                        { type: 'C', x: 70, y: -40 },
                        { type: 'C', x: 70, y: 40 },
                        { type: 'C', x: 0, y: 80 },
                        { type: 'C', x: -70, y: 40 },
                        { type: 'C', x: -70, y: -40 },
                        { type: 'H', x: 0, y: -140 },
                        { type: 'H', x: 140, y: -40 },
                        { type: 'H', x: 140, y: 40 },
                        { type: 'H', x: 0, y: 140 },
                        { type: 'H', x: -140, y: 40 },
                        { type: 'H', x: -140, y: -40 }
                    ],
                    bonds: [
                        { atom1Index: 0, atom2Index: 1, type: 'single' },
                        { atom1Index: 1, atom2Index: 2, type: 'double' },
                        { atom1Index: 2, atom2Index: 3, type: 'single' },
                        { atom1Index: 3, atom2Index: 4, type: 'double' },
                        { atom1Index: 4, atom2Index: 5, type: 'single' },
                        { atom1Index: 5, atom2Index: 0, type: 'double' },
                        { atom1Index: 0, atom2Index: 6, type: 'single' },
                        { atom1Index: 1, atom2Index: 7, type: 'single' },
                        { atom1Index: 2, atom2Index: 8, type: 'single' },
                        { atom1Index: 3, atom2Index: 9, type: 'single' },
                        { atom1Index: 4, atom2Index: 10, type: 'single' },
                        { atom1Index: 5, atom2Index: 11, type: 'single' }
                    ]
                },
                'nitro': {
                    name: '硝基',
                    atoms: [
                        { type: 'N', x: 0, y: 0 },
                        { type: 'O', x: 60, y: -25 },
                        { type: 'O', x: 60, y: 25 }
                    ],
                    bonds: [
                        { atom1Index: 0, atom2Index: 1, type: 'double' },
                        { atom1Index: 0, atom2Index: 2, type: 'single' } // 改为单键，解决价键问题
                    ]
                },
                'sulfhydryl': {
                    name: '巯基',
                    atoms: [
                        { type: 'S', x: 0, y: 0 },
                        { type: 'H', x: 45, y: 0 }
                    ],
                    bonds: [
                        { atom1Index: 0, atom2Index: 1, type: 'single' }
                    ]
                },
                'methyl': {
                    name: '甲基',
                    atoms: [
                        { type: 'C', x: 0, y: 0 },
                        { type: 'H', x: -40, y: 0 },
                        { type: 'H', x: 0, y: 40 },
                        { type: 'H', x: 0, y: -40 }
                    ],
                    bonds: [
                        { atom1Index: 0, atom2Index: 1, type: 'single' },
                        { atom1Index: 0, atom2Index: 2, type: 'single' },
                        { atom1Index: 0, atom2Index: 3, type: 'single' }
                    ]
                }
            };
            
            // 设置Canvas尺寸为100%
            function resizeCanvas() {
                const container = canvas.parentElement;
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                drawAll();
            }
            
            window.addEventListener('resize', resizeCanvas);
            
            // 坐标转换函数
            function screenToWorld(screenX, screenY) {
                return {
                    x: (screenX - offsetX) / scale,
                    y: (screenY - offsetY) / scale
                };
            }
            
            function worldToScreen(worldX, worldY) {
                return {
                    x: worldX * scale + offsetX,
                    y: worldY * scale + offsetY
                };
            }
            
            // 原子类
            class Atom {
                constructor(type, x, y) {
                    this.id = atomIdCounter++;
                    this.type = type;
                    this.x = x;
                    this.y = y;
                    this.bonds = [];
                    this.properties = atomProperties[type];
                    this.isDragging = false;
                }
                
                getRemainingValence() {
                    let used = 0;
                    this.bonds.forEach(bondId => {
                        const bond = bonds.find(b => b.id === bondId);
                        if (bond) {
                            if (bond.type === 'single') used += 1;
                            else if (bond.type === 'double') used += 2;
                            else if (bond.type === 'triple') used += 3;
                            else used += 1;
                        }
                    });
                    return this.properties.valence - used;
                }
                
                canBondWith(otherAtom, bondType) {
                    const bondWeight = bondType === 'single' ? 1 : bondType === 'double' ? 2 : 3;
                    return this.getRemainingValence() >= bondWeight && 
                           otherAtom.getRemainingValence() >= bondWeight;
                }
                
                draw() {
                    const screenPos = worldToScreen(this.x, this.y);
                    const radius = this.properties.radius * scale;
                    
                    ctx.beginPath();
                    ctx.arc(screenPos.x, screenPos.y, radius, 0, Math.PI * 2);
                    ctx.fillStyle = this.properties.color;
                    ctx.fill();
                    ctx.strokeStyle = '#f8f8f2';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // 绘制原子符号
                    ctx.fillStyle = '#0a192f';
                    ctx.font = `bold ${Math.max(12, radius * 0.6)}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(this.type, screenPos.x, screenPos.y);
                    
                    // 显示剩余价键
                    const remaining = this.getRemainingValence();
                    if (remaining > 0) {
                        ctx.fillStyle = '#64ffda';
                        ctx.font = `bold ${Math.max(8, radius * 0.4)}px Arial`;
                        ctx.fillText(remaining, screenPos.x + radius * 0.6, screenPos.y - radius * 0.6);
                    }
                    
                    // 如果原子正在被拖拽，绘制拖拽效果
                    if (this.isDragging) {
                        ctx.beginPath();
                        ctx.arc(screenPos.x, screenPos.y, radius + 5, 0, Math.PI * 2);
                        ctx.strokeStyle = '#64ffda';
                        ctx.lineWidth = 2;
                        ctx.setLineDash([5, 5]);
                        ctx.stroke();
                        ctx.setLineDash([]);
                    }
                }
                
                isClicked(screenX, screenY) {
                    const worldPos = screenToWorld(screenX, screenY);
                    const distance = Math.sqrt((worldPos.x - this.x) ** 2 + (worldPos.y - this.y) ** 2);
                    const radius = this.properties.radius;
                    return distance <= radius * 1.2;
                }
                
                // 移动到新位置
                moveTo(x, y) {
                    this.x = x;
                    this.y = y;
                }
            }
            
            // 化学键类
            class Bond {
                constructor(atom1Id, atom2Id, type) {
                    this.id = bondIdCounter++;
                    this.atom1Id = atom1Id;
                    this.atom2Id = atom2Id;
                    this.type = type;
                }
                
                getAtoms() {
                    return {
                        atom1: atoms.find(a => a.id === this.atom1Id),
                        atom2: atoms.find(a => a.id === this.atom2Id)
                    };
                }
                
                draw() {
                    const { atom1, atom2 } = this.getAtoms();
                    if (!atom1 || !atom2) return;
                    
                    const screenPos1 = worldToScreen(atom1.x, atom1.y);
                    const screenPos2 = worldToScreen(atom2.x, atom2.y);
                    
                    ctx.beginPath();
                    ctx.moveTo(screenPos1.x, screenPos1.y);
                    ctx.lineTo(screenPos2.x, screenPos2.y);
                    ctx.strokeStyle = '#f8f8f2';
                    ctx.lineWidth = bondProperties[this.type].width * scale;
                    
                    if (this.type === 'dash') {
                        ctx.setLineDash(bondProperties[this.type].dash.map(d => d * scale));
                    } else {
                        ctx.setLineDash([]);
                    }
                    
                    ctx.stroke();
                    
                    // 重置虚线
                    ctx.setLineDash([]);
                    
                    // 双键和三键的特殊绘制
                    if (this.type === 'double') {
                        // 计算垂直方向
                        const dx = screenPos2.x - screenPos1.x;
                        const dy = screenPos2.y - screenPos1.y;
                        const length = Math.sqrt(dx * dx + dy * dy);
                        const perpendicularX = -dy / length * 4 * scale;
                        const perpendicularY = dx / length * 4 * scale;
                        
                        ctx.beginPath();
                        ctx.moveTo(screenPos1.x + perpendicularX, screenPos1.y + perpendicularY);
                        ctx.lineTo(screenPos2.x + perpendicularX, screenPos2.y + perpendicularY);
                        ctx.stroke();
                    } else if (this.type === 'triple') {
                        // 计算垂直方向
                        const dx = screenPos2.x - screenPos1.x;
                        const dy = screenPos2.y - screenPos1.y;
                        const length = Math.sqrt(dx * dx + dy * dy);
                        const perpendicularX = -dy / length * 6 * scale;
                        const perpendicularY = dx / length * 6 * scale;
                        
                        ctx.beginPath();
                        ctx.moveTo(screenPos1.x + perpendicularX, screenPos1.y + perpendicularY);
                        ctx.lineTo(screenPos2.x + perpendicularX, screenPos2.y + perpendicularY);
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.moveTo(screenPos1.x - perpendicularX, screenPos1.y - perpendicularY);
                        ctx.lineTo(screenPos2.x - perpendicularX, screenPos2.y - perpendicularY);
                        ctx.stroke();
                    }
                }
            }
            
            // 绘制所有
            function drawAll() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // 绘制化学键
                bonds.forEach(bond => bond.draw());
                
                // 绘制原子
                atoms.forEach(atom => atom.draw());
                
                // 绘制选中效果
                if (selectedAtom) {
                    const screenPos = worldToScreen(selectedAtom.x, selectedAtom.y);
                    const radius = selectedAtom.properties.radius * scale;
                    
                    ctx.beginPath();
                    ctx.arc(screenPos.x, screenPos.y, radius + 5, 0, Math.PI * 2);
                    ctx.strokeStyle = '#64ffda';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }
            }
            
            // 更新缩放显示
            function updateZoomDisplay() {
                const zoomPercent = Math.round(scale * 100);
                zoomDisplay.textContent = `缩放: ${zoomPercent}%`;
                zoomLevel.textContent = `${zoomPercent}%`;
            }
            
            // 缩放画布
            function zoomAtPoint(delta, x, y) {
                const oldScale = scale;
                scale += delta * scale * 0.1;
                scale = Math.max(minScale, Math.min(maxScale, scale));
                
                // 调整偏移量，使缩放以鼠标位置为中心
                const worldPos = screenToWorld(x, y);
                offsetX = x - worldPos.x * scale;
                offsetY = y - worldPos.y * scale;
                
                updateZoomDisplay();
                drawAll();
            }
            
            // 重置视图
            function resetView() {
                scale = 1;
                offsetX = 0;
                offsetY = 0;
                updateZoomDisplay();
                drawAll();
                showNotification('视图已重置', 'info');
            }
            
            // 检查原子间距是否足够
            function checkAtomDistance(x, y, minDistance = 35) {
                for (const atom of atoms) {
                    const distance = Math.sqrt((x - atom.x) ** 2 + (y - atom.y) ** 2);
                    if (distance < minDistance) {
                        return { tooClose: true, distance };
                    }
                }
                return { tooClose: false, distance: 0 };
            }
            
            // 添加原子
            function addAtom(type, x, y) {
                // 检查是否太靠近其他原子
                const distanceCheck = checkAtomDistance(x, y, 35);
                
                if (distanceCheck.tooClose) {
                    showNotification(`位置太靠近其他原子 (距离: ${distanceCheck.distance.toFixed(1)})`, 'warning');
                    return null;
                }
                
                const atom = new Atom(type, x, y);
                atoms.push(atom);
                updateInfo();
                drawAll();
                return atom;
            }
            
            // 添加化学键
            function addBond(atom1Id, atom2Id, type) {
                // 检查是否已存在
                const existing = bonds.find(bond => 
                    (bond.atom1Id === atom1Id && bond.atom2Id === atom2Id) ||
                    (bond.atom1Id === atom2Id && bond.atom2Id === atom1Id)
                );
                
                if (existing) {
                    showNotification('化学键已存在', 'warning');
                    return null;
                }
                
                const atom1 = atoms.find(a => a.id === atom1Id);
                const atom2 = atoms.find(a => a.id === atom2Id);
                
                if (!atom1 || !atom2) return null;
                
                // 检查价键是否足够
                if (!atom1.canBondWith(atom2, type)) {
                    showNotification('价键不足', 'warning');
                    return null;
                }
                
                const bond = new Bond(atom1Id, atom2Id, type);
                bonds.push(bond);
                
                // 更新原子的键列表
                atom1.bonds.push(bond.id);
                atom2.bonds.push(bond.id);
                
                updateInfo();
                drawAll();
                return bond;
            }
            
            // 更新信息面板
            function updateInfo() {
                document.getElementById('atom-count').textContent = atoms.length;
            }
            
            // 显示通知
            function showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                const content = document.getElementById('notification-content');
                content.textContent = message;
                
                if (type === 'warning') {
                    notification.style.borderLeftColor = '#ffb86c';
                } else if (type === 'success') {
                    notification.style.borderLeftColor = '#50fa7b';
                } else {
                    notification.style.borderLeftColor = '#64ffda';
                }
                
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
            
            // 检测环状结构 - 改进版，返回环信息
            function detectCyclicStructure() {
                if (atoms.length < 3) return { isCyclic: false, cycleAtoms: [], doubleBondCount: 0 };
                
                const carbonAtoms = atoms.filter(a => a.type === 'C');
                if (carbonAtoms.length < 3) return { isCyclic: false, cycleAtoms: [], doubleBondCount: 0 };
                
                const visited = new Set();
                const stack = [];
                let cycleAtoms = [];
                
                function dfs(atom, parent) {
                    visited.add(atom.id);
                    stack.push(atom.id);
                    
                    // 获取邻居原子
                    const neighbors = [];
                    atom.bonds.forEach(bondId => {
                        const bond = bonds.find(b => b.id === bondId);
                        if (!bond) return;
                        
                        const neighborId = bond.atom1Id === atom.id ? bond.atom2Id : bond.atom1Id;
                        const neighbor = atoms.find(a => a.id === neighborId);
                        if (neighbor && neighbor.type === 'C') {
                            neighbors.push(neighbor);
                        }
                    });
                    
                    for (const neighbor of neighbors) {
                        if (neighbor.id === parent) continue;
                        
                        if (visited.has(neighbor.id)) {
                            // 找到环
                            const startIndex = stack.indexOf(neighbor.id);
                            cycleAtoms = stack.slice(startIndex);
                            return true;
                        }
                        
                        if (dfs(neighbor, atom.id)) {
                            return true;
                        }
                    }
                    
                    stack.pop();
                    return false;
                }
                
                for (const atom of carbonAtoms) {
                    if (!visited.has(atom.id)) {
                        if (dfs(atom, null)) {
                            // 计算环内双键数量
                            let doubleBondCount = 0;
                            for (let i = 0; i < cycleAtoms.length; i++) {
                                const atom1Id = cycleAtoms[i];
                                const atom2Id = cycleAtoms[(i + 1) % cycleAtoms.length];
                                const bond = bonds.find(b => 
                                    (b.atom1Id === atom1Id && b.atom2Id === atom2Id) ||
                                    (b.atom1Id === atom2Id && b.atom2Id === atom1Id)
                                );
                                if (bond && bond.type === 'double') {
                                    doubleBondCount++;
                                }
                            }
                            return { 
                                isCyclic: true, 
                                cycleAtoms: cycleAtoms, 
                                doubleBondCount: doubleBondCount,
                                atomCount: cycleAtoms.length
                            };
                        }
                    }
                }
                
                return { isCyclic: false, cycleAtoms: [], doubleBondCount: 0 };
            }
            
            // 检测苯环结构 - 改进版
            function detectBenzeneRing() {
                const cyclicInfo = detectCyclicStructure();
                if (!cyclicInfo.isCyclic) return false;
                
                // 苯环有6个碳原子，3个双键
                if (cyclicInfo.atomCount === 6 && cyclicInfo.doubleBondCount === 3) {
                    // 进一步验证双键交替排列
                    const cycleAtoms = cyclicInfo.cycleAtoms;
                    let alternating = true;
                    
                    for (let i = 0; i < cycleAtoms.length; i++) {
                        const atom1Id = cycleAtoms[i];
                        const atom2Id = cycleAtoms[(i + 1) % cycleAtoms.length];
                        const bond = bonds.find(b => 
                            (b.atom1Id === atom1Id && b.atom2Id === atom2Id) ||
                            (b.atom1Id === atom2Id && b.atom2Id === atom1Id)
                        );
                        
                        // 检查双键是否交替：位置0-1应该是单键，1-2是双键，2-3是单键，等等
                        const expectedType = i % 2 === 0 ? 'single' : 'double';
                        if (bond && bond.type !== expectedType) {
                            alternating = false;
                            break;
                        }
                    }
                    
                    return alternating;
                }
                return false;
            }
            
            // 检测环己烷
            function detectCyclohexane() {
                const cyclicInfo = detectCyclicStructure();
                if (!cyclicInfo.isCyclic) return false;
                
                // 环己烷有6个碳原子，没有双键
                if (cyclicInfo.atomCount === 6 && cyclicInfo.doubleBondCount === 0) {
                    return true;
                }
                return false;
            }
            
            // 生成化合物信息
            function generateCompoundInfo() {
                if (atoms.length === 0) {
                    showNotification('请先添加原子', 'warning');
                    return;
                }
                
                // 计算原子数量
                const atomCounts = {};
                atoms.forEach(atom => {
                    atomCounts[atom.type] = (atomCounts[atom.type] || 0) + 1;
                });
                
                // 计算分子量和分子式
                let molecularWeight = 0;
                atoms.forEach(atom => {
                    molecularWeight += atom.properties.mass;
                });
                
                // 构建分子式
                let formula = '';
                const order = ['C', 'H', 'O', 'N', 'Cl', 'S', 'F', 'Br', 'I'];
                order.forEach(element => {
                    if (atomCounts[element]) {
                        formula += element + (atomCounts[element] > 1 ? atomCounts[element] : '');
                    }
                });
                
                // 生成标准IUPAC名称
                let name = generateIUPACName();
                
                // 更新UI
                document.getElementById('compound-name').textContent = name;
                document.getElementById('compound-formula').textContent = formula;
                document.getElementById('iupac-name').textContent = name;
                document.getElementById('molecular-formula').textContent = formula;
                document.getElementById('molecular-weight').textContent = molecularWeight.toFixed(2);
                
                // 计算不饱和度
                let unsaturation = 0;
                const cCount = atomCounts['C'] || 0;
                const hCount = atomCounts['H'] || 0;
                const nCount = atomCounts['N'] || 0;
                const halogenCount = (atomCounts['Cl'] || 0) + (atomCounts['F'] || 0) + (atomCounts['Br'] || 0) + (atomCounts['I'] || 0);
                
                // 不饱和度公式: Ω = (2C + 2 + N - H - X) / 2
                unsaturation = (2 * cCount + 2 + nCount - hCount - halogenCount) / 2;
                document.getElementById('unsaturation-index').textContent = unsaturation.toFixed(1);
                
                // 添加到历史记录
                addToHistory(name, formula);
                
                showNotification('化合物信息已生成', 'success');
            }
            
            // 生成IUPAC名称（改进版命名法）- 修复版
            function generateIUPACName() {
                if (atoms.length === 0) return "无分子";
                
                // 计算原子数量
                const atomCounts = {};
                atoms.forEach(atom => {
                    atomCounts[atom.type] = (atomCounts[atom.type] || 0) + 1;
                });
                
                const cCount = atomCounts['C'] || 0;
                const hCount = atomCounts['H'] || 0;
                const oCount = atomCounts['O'] || 0;
                const nCount = atomCounts['N'] || 0;
                const sCount = atomCounts['S'] || 0;
                const clCount = atomCounts['Cl'] || 0;
                const fCount = atomCounts['F'] || 0;
                const brCount = atomCounts['Br'] || 0;
                const iCount = atomCounts['I'] || 0;
                
                // 特殊化合物检测
                // 1. C2F2Br2 (1,2-二溴-1,2-二氟乙烯)
                if (cCount === 2 && fCount === 2 && brCount === 2 && hCount === 0 && oCount === 0 && nCount === 0 && sCount === 0 && clCount === 0 && iCount === 0) {
                    // 检查是否有双键
                    const hasDoubleBond = bonds.some(b => b.type === 'double');
                    if (hasDoubleBond) {
                        return "1,2-二溴-1,2-二氟乙烯";
                    }
                }
                
                // 2. 乙烯 C2H4
                if (cCount === 2 && hCount === 4 && fCount === 0 && brCount === 0 && clCount === 0 && iCount === 0 && oCount === 0 && nCount === 0 && sCount === 0) {
                    const hasDoubleBond = bonds.some(b => b.type === 'double');
                    if (hasDoubleBond) {
                        return "乙烯";
                    }
                }
                
                // 检测官能团
                const hasDoubleBond = bonds.some(b => b.type === 'double');
                const hasTripleBond = bonds.some(b => b.type === 'triple');
                
                // 检测环状结构
                const cyclicInfo = detectCyclicStructure();
                const isCyclic = cyclicInfo.isCyclic;
                
                // 检测苯环结构（使用改进的检测方法）
                const hasBenzeneRing = detectBenzeneRing();
                
                // 检测环己烷
                const isCyclohexane = detectCyclohexane();
                
                // 检测羟基 - 改进版
                let hasHydroxyl = false;
                let hydroxylCount = 0;
                for (const atom of atoms) {
                    if (atom.type === 'O') {
                        const connectedAtoms = atom.bonds.map(bondId => {
                            const bond = bonds.find(b => b.id === bondId);
                            if (!bond) return null;
                            const otherAtomId = bond.atom1Id === atom.id ? bond.atom2Id : bond.atom1Id;
                            return atoms.find(a => a.id === otherAtomId);
                        }).filter(a => a);
                        
                        const hydrogenAtoms = connectedAtoms.filter(a => a.type === 'H');
                        const carbonAtoms = connectedAtoms.filter(a => a.type === 'C');
                        
                        if (hydrogenAtoms.length >= 1 && carbonAtoms.length >= 1) {
                            hasHydroxyl = true;
                            hydroxylCount++;
                        }
                    }
                }
                
                // 检测双键 - 改进版，用于烯醇检测
                let doubleBondCarbonCount = 0;
                let doubleBondPositions = [];
                for (const bond of bonds) {
                    if (bond.type === 'double') {
                        const { atom1, atom2 } = bond.getAtoms();
                        if (atom1 && atom2) {
                            if (atom1.type === 'C' && atom2.type === 'C') {
                                doubleBondCarbonCount++;
                                doubleBondPositions.push({ atom1: atom1, atom2: atom2 });
                            }
                        }
                    }
                }
                
                // 检测烯醇结构（同时有双键和羟基）
                let hasEnolStructure = false;
                if (hasDoubleBond && hasHydroxyl && doubleBondPositions.length > 0) {
                    // 检查羟基是否连接到双键碳上
                    for (const doubleBond of doubleBondPositions) {
                        for (const atom of atoms) {
                            if (atom.type === 'O' && hasHydroxyl) {
                                const connectedAtoms = atom.bonds.map(bondId => {
                                    const bond = bonds.find(b => b.id === bondId);
                                    if (!bond) return null;
                                    const otherAtomId = bond.atom1Id === atom.id ? bond.atom2Id : bond.atom1Id;
                                    return atoms.find(a => a.id === otherAtomId);
                                }).filter(a => a);
                                
                                // 检查羟基是否连接到双键碳上
                                const connectedToDoubleBondCarbon = connectedAtoms.some(connectedAtom => 
                                    connectedAtom.id === doubleBond.atom1.id || connectedAtom.id === doubleBond.atom2.id
                                );
                                
                                if (connectedToDoubleBondCarbon) {
                                    hasEnolStructure = true;
                                    break;
                                }
                            }
                        }
                        if (hasEnolStructure) break;
                    }
                }
                
                // 检测羧基
                let hasCarboxyl = false;
                for (const atom of atoms) {
                    if (atom.type === 'C') {
                        const connectedAtoms = atom.bonds.map(bondId => {
                            const bond = bonds.find(b => b.id === bondId);
                            if (!bond) return null;
                            const otherAtomId = bond.atom1Id === atom.id ? bond.atom2Id : bond.atom1Id;
                            return atoms.find(a => a.id === otherAtomId);
                        }).filter(a => a);
                        
                        let doubleBondOxygen = null;
                        let singleBondOxygen = null;
                        
                        for (const connectedAtom of connectedAtoms) {
                            if (connectedAtom.type === 'O') {
                                const bond = bonds.find(b => 
                                    (b.atom1Id === atom.id && b.atom2Id === connectedAtom.id) ||
                                    (b.atom2Id === atom.id && b.atom1Id === connectedAtom.id)
                                );
                                if (bond && bond.type === 'double') {
                                    doubleBondOxygen = connectedAtom;
                                } else if (bond && bond.type === 'single') {
                                    singleBondOxygen = connectedAtom;
                                }
                            }
                        }
                        
                        if (doubleBondOxygen && singleBondOxygen) {
                            const hydroxylHydrogen = singleBondOxygen.bonds.some(bondId => {
                                const bond = bonds.find(b => b.id === bondId);
                                if (!bond) return false;
                                const otherAtomId = bond.atom1Id === singleBondOxygen.id ? bond.atom2Id : bond.atom1Id;
                                const otherAtom = atoms.find(a => a.id === otherAtomId);
                                return otherAtom && otherAtom.type === 'H';
                            });
                            
                            if (hydroxylHydrogen) {
                                hasCarboxyl = true;
                                break;
                            }
                        }
                    }
                }
                
                // 检测醛基
                let hasAldehyde = false;
                for (const atom of atoms) {
                    if (atom.type === 'C') {
                        const connectedAtoms = atom.bonds.map(bondId => {
                            const bond = bonds.find(b => b.id === bondId);
                            if (!bond) return null;
                            const otherAtomId = bond.atom1Id === atom.id ? bond.atom2Id : bond.atom1Id;
                            return atoms.find(a => a.id === otherAtomId);
                        }).filter(a => a);
                        
                        let doubleBondOxygen = null;
                        for (const connectedAtom of connectedAtoms) {
                            if (connectedAtom.type === 'O') {
                                const bond = bonds.find(b => 
                                    (b.atom1Id === atom.id && b.atom2Id === connectedAtom.id) ||
                                    (b.atom2Id === atom.id && b.atom1Id === connectedAtom.id)
                                );
                                if (bond && bond.type === 'double') {
                                    doubleBondOxygen = connectedAtom;
                                    break;
                                }
                            }
                        }
                        
                        const hydrogenAtoms = connectedAtoms.filter(a => a.type === 'H');
                        
                        if (doubleBondOxygen && hydrogenAtoms.length >= 1) {
                            hasAldehyde = true;
                            break;
                        }
                    }
                }
                
                // 检测硝基
                let hasNitro = false;
                let nitroCount = 0;
                for (const atom of atoms) {
                    if (atom.type === 'N') {
                        const connectedAtoms = atom.bonds.map(bondId => {
                            const bond = bonds.find(b => b.id === bondId);
                            if (!bond) return null;
                            const otherAtomId = bond.atom1Id === atom.id ? bond.atom2Id : bond.atom1Id;
                            return atoms.find(a => a.id === otherAtomId);
                        }).filter(a => a);
                        
                        const oxygenAtoms = connectedAtoms.filter(a => a.type === 'O');
                        const carbonAtoms = connectedAtoms.filter(a => a.type === 'C');
                        
                        // 硝基：氮原子连接一个碳原子和两个氧原子（一个双键，一个单键）
                        if (oxygenAtoms.length >= 2 && carbonAtoms.length >= 1) {
                            // 检查键型
                            let doubleBondOxygen = false;
                            let singleBondOxygen = false;
                            
                            for (const oxygen of oxygenAtoms) {
                                const bond = bonds.find(b => 
                                    (b.atom1Id === atom.id && b.atom2Id === oxygen.id) ||
                                    (b.atom2Id === atom.id && b.atom1Id === oxygen.id)
                                );
                                if (bond && bond.type === 'double') {
                                    doubleBondOxygen = true;
                                } else if (bond && bond.type === 'single') {
                                    singleBondOxygen = true;
                                }
                            }
                            
                            if (doubleBondOxygen && singleBondOxygen) {
                                hasNitro = true;
                                nitroCount++;
                            }
                        }
                    }
                }
                
                // 检测甲基
                let hasMethyl = false;
                for (const atom of atoms) {
                    if (atom.type === 'C') {
                        const connectedAtoms = atom.bonds.map(bondId => {
                            const bond = bonds.find(b => b.id === bondId);
                            if (!bond) return null;
                            const otherAtomId = bond.atom1Id === atom.id ? bond.atom2Id : bond.atom1Id;
                            return atoms.find(a => a.id === otherAtomId);
                        }).filter(a => a);
                        
                        const hydrogenAtoms = connectedAtoms.filter(a => a.type === 'H');
                        const otherCarbons = connectedAtoms.filter(a => a.type === 'C');
                        
                        // 甲基：碳原子连接3个氢原子和最多1个其他碳原子
                        if (hydrogenAtoms.length >= 3 && otherCarbons.length <= 1) {
                            hasMethyl = true;
                            break;
                        }
                    }
                }
                
                // 检测硫醇/硫醚
                let hasThiol = false;
                let hasThioether = false;
                for (const atom of atoms) {
                    if (atom.type === 'S') {
                        const connectedAtoms = atom.bonds.map(bondId => {
                            const bond = bonds.find(b => b.id === bondId);
                            if (!bond) return null;
                            const otherAtomId = bond.atom1Id === atom.id ? bond.atom2Id : bond.atom1Id;
                            return atoms.find(a => a.id === otherAtomId);
                        }).filter(a => a);
                        
                        const hydrogenAtoms = connectedAtoms.filter(a => a.type === 'H');
                        const carbonAtoms = connectedAtoms.filter(a => a.type === 'C');
                        
                        // 硫醇：硫原子连接一个氢原子
                        if (hydrogenAtoms.length >= 1) {
                            hasThiol = true;
                        }
                        
                        // 硫醚：硫原子连接两个碳原子
                        if (carbonAtoms.length >= 2) {
                            hasThioether = true;
                        }
                    }
                }
                
                // 基础命名
                const alkaneNames = ["甲烷", "乙烷", "丙烷", "丁烷", "戊烷", "己烷", "庚烷", "辛烷", "壬烷", "癸烷"];
                const alkeneNames = ["乙烯", "丙烯", "丁烯", "戊烯", "己烯", "庚烯", "辛烯", "壬烯", "癸烯"];
                const alkyneNames = ["乙炔", "丙炔", "丁炔", "戊炔", "己炔", "庚炔", "辛炔", "壬炔", "癸炔"];
                const cycloAlkaneNames = ["环丙烷", "环丁烷", "环戊烷", "环己烷", "环庚烷", "环辛烷", "环壬烷", "环癸烷"];
                const cycloAlkeneNames = ["环丙烯", "环丁烯", "环戊烯", "环己烯", "环庚烯", "环辛烯", "环壬烯", "环癸烯"];
                
                // 根据检测结果生成名称
                
                // 1. 苯环结构
                if (hasBenzeneRing) {
                    // TNT (2,4,6-三硝基甲苯)
                    if (nitroCount >= 3 && hasMethyl) {
                        return "2,4,6-三硝基甲苯(TNT)";
                    } else if (hasMethyl) {
                        return "甲苯";
                    } else {
                        return "苯";
                    }
                }
                
                // 2. 环己烷（必须在苯环检测之后）
                if (isCyclohexane) {
                    return "环己烷";
                }
                
                // 3. 烯醇结构（2-羟基丙烯等）- 优先于普通醇和烯烃
                if (hasEnolStructure) {
                    if (cCount === 3 && hasDoubleBond && hasHydroxyl) {
                        // 检查羟基位置
                        let hydroxylOnMiddleCarbon = false;
                        for (const atom of atoms) {
                            if (atom.type === 'O' && hasHydroxyl) {
                                const connectedAtoms = atom.bonds.map(bondId => {
                                    const bond = bonds.find(b => b.id === bondId);
                                    if (!bond) return null;
                                    const otherAtomId = bond.atom1Id === atom.id ? bond.atom2Id : bond.atom1Id;
                                    return atoms.find(a => a.id === otherAtomId);
                                }).filter(a => a);
                                
                                const carbonAtoms = connectedAtoms.filter(a => a.type === 'C');
                                if (carbonAtoms.length > 0) {
                                    // 简单判断：如果有3个碳原子，双键在1-2位置，羟基在2号碳上，就是2-羟基丙烯
                                    if (cCount === 3) {
                                        return "2-羟基丙烯";
                                    }
                                }
                            }
                        }
                        return "烯醇";
                    }
                }
                
                // 4. 羧酸
                if (hasCarboxyl) {
                    if (cCount === 2) return "乙酸";
                    if (cCount === 1) return "甲酸";
                    if (cCount <= 10) {
                        const acidNames = ["甲酸", "乙酸", "丙酸", "丁酸", "戊酸", "己酸", "庚酸", "辛酸", "壬酸", "癸酸"];
                        return acidNames[cCount - 1];
                    }
                    return `${cCount}碳酸`;
                }
                
                // 5. 醛类
                if (hasAldehyde) {
                    if (cCount <= 10) {
                        const aldehydeNames = ["甲醛", "乙醛", "丙醛", "丁醛", "戊醛", "己醛", "庚醛", "辛醛", "壬醛", "癸醛"];
                        return aldehydeNames[cCount - 1];
                    }
                    return `${cCount}碳醛`;
                }
                
                // 6. 其他环状化合物
                if (isCyclic) {
                    if (hasDoubleBond) {
                        if (cCount >= 3 && cCount <= 10) {
                            return cycloAlkeneNames[cCount - 3];
                        }
                        return `环${cCount}烯`;
                    } else {
                        if (cCount >= 3 && cCount <= 10) {
                            return cycloAlkaneNames[cCount - 3];
                        }
                        return `环${cCount}烷`;
                    }
                }
                
                // 7. 醇类（只有在不是烯醇的情况下）
                if (hasHydroxyl && !hasEnolStructure) {
                    if (cCount <= 10) return alkaneNames[cCount - 1].replace("烷", "醇");
                    return `${cCount}碳醇`;
                }
                
                // 8. 烯烃
                if (hasDoubleBond && !hasTripleBond) {
                    if (cCount === 2 && hCount === 4) {
                        return "乙烯";
                    }
                    if (cCount <= 10) return alkeneNames[cCount - 2] + (cCount > 2 ? "-1-烯" : "");
                    return `${cCount}碳烯`;
                }
                
                // 9. 炔烃
                if (hasTripleBond) {
                    if (cCount === 2 && hCount === 2) {
                        return "乙炔";
                    }
                    if (cCount <= 10) return alkyneNames[cCount - 2] + (cCount > 2 ? "-1-炔" : "");
                    return `${cCount}碳炔`;
                }
                
                // 10. 硫醇
                if (hasThiol) {
                    if (cCount <= 10) {
                        const thiolNames = ["甲硫醇", "乙硫醇", "丙硫醇", "丁硫醇", "戊硫醇", "己硫醇", "庚硫醇", "辛硫醇", "壬硫醇", "癸硫醇"];
                        return thiolNames[cCount - 1];
                    }
                    return `${cCount}碳硫醇`;
                }
                
                // 11. 硫醚
                if (hasThioether) {
                    if (cCount <= 10) {
                        const thioetherNames = ["甲硫醚", "乙硫醚", "丙硫醚", "丁硫醚", "戊硫醚", "己硫醚", "庚硫醚", "辛硫醚", "壬硫醚", "癸硫醚"];
                        return thioetherNames[cCount - 1];
                    }
                    return `${cCount}碳硫醚`;
                }
                
                // 12. 含硫化合物（一般情况）
                if (sCount > 0) {
                    if (cCount <= 10) {
                        if (cCount === 1 && hCount >= 4 && sCount === 1) {
                            return "甲硫醇";
                        }
                        return `${alkaneNames[cCount - 1]}硫化物`;
                    }
                    return `${cCount}碳硫化物`;
                }
                
                // 13. 卤代烃
                const halogenCount = clCount + fCount + brCount + iCount;
                if (halogenCount > 0) {
                    let halogenName = "";
                    if (clCount > 0) halogenName += "氯";
                    if (fCount > 0) halogenName += "氟";
                    if (brCount > 0) halogenName += "溴";
                    if (iCount > 0) halogenName += "碘";
                    
                    if (halogenCount > 1) halogenName += "代";
                    
                    // 对于乙烯的卤代物特殊处理
                    if (cCount === 2 && hasDoubleBond) {
                        if (fCount === 2 && brCount === 2 && hCount === 0) {
                            return "1,2-二溴-1,2-二氟乙烯";
                        }
                        return halogenName + "乙烯";
                    }
                    
                    if (cCount <= 10) return halogenName + alkaneNames[cCount - 1];
                    return `${halogenName}${cCount}碳烷`;
                }
                
                // 14. 烷烃
                if (cCount > 0 && !hasDoubleBond && !hasTripleBond && !hasHydroxyl && !hasCarboxyl && !hasAldehyde) {
                    if (cCount <= 10) return alkaneNames[cCount - 1];
                    return `${cCount}碳烷`;
                }
                
                // 15. 硝基化合物
                if (hasNitro) {
                    if (cCount <= 10) return `硝基${alkaneNames[cCount - 1]}`;
                    return `硝基${cCount}碳烷`;
                }
                
                // 16. 含氮化合物
                if (nCount > 0) {
                    if (cCount <= 10) return `${alkaneNames[cCount - 1]}胺`;
                    return `${cCount}碳胺`;
                }
                
                return "有机化合物";
            }
            
            // 添加到历史记录
            function addToHistory(name, formula) {
                const historyList = document.getElementById('history-list');
                
                const existing = Array.from(historyList.children).some(item => {
                    const itemName = item.querySelector('.history-name').textContent;
                    return itemName === name;
                });
                
                if (existing) return;
                
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-name">${name}</div>
                    <div class="history-formula">${formula}</div>
                `;
                
                historyItem.addEventListener('click', function() {
                    loadExampleFromHistory(name);
                });
                
                historyList.insertBefore(historyItem, historyList.firstChild);
                
                if (historyList.children.length > 8) {
                    historyList.removeChild(historyList.lastChild);
                }
            }
            
            // 从历史记录加载
            function loadExampleFromHistory(name) {
                const exampleMap = {
                    '甲烷': 'methane',
                    '乙烷': 'ethane',
                    '乙烯': 'ethene',
                    '乙醇': 'ethanol',
                    '苯': 'benzene',
                    '甲苯': 'toluene',
                    '2,4,6-三硝基甲苯(TNT)': 'tnt',
                    '乙酸': 'acetic_acid',
                    '环丁烷': 'cyclobutane',
                    '环己烷': 'cyclohexane',
                    '1,2-二溴-1,2-二氟乙烯': 'c2f2br2',
                    '乙炔': 'acetylene',
                    '丙烯': 'propene',
                    '2-羟基丙烯': 'hydroxypropene'
                };
                
                const example = exampleMap[name];
                if (example) {
                    loadExample(example);
                } else {
                    showNotification(`无法加载 ${name}`, 'warning');
                }
            }
            
            // 清除所有
            function clearAll() {
                atoms = [];
                bonds = [];
                selectedAtom = null;
                moleculeRotation = 0;
                
                document.getElementById('compound-name').textContent = "未命名化合物";
                document.getElementById('compound-formula').textContent = "C?H?";
                document.getElementById('iupac-name').textContent = "-";
                document.getElementById('molecular-formula').textContent = "-";
                document.getElementById('molecular-weight').textContent = "-";
                document.getElementById('unsaturation-index').textContent = "-";
                document.getElementById('atom-count').textContent = "0";
                
                updateCursorInfo();
                drawAll();
                showNotification('已清除所有原子和化学键', 'info');
            }
            
            // 添加官能团
            function addFunctionalGroup(groupId, x, y) {
                const group = functionalGroups[groupId];
                if (!group) {
                    showNotification(`官能团 ${groupId} 未定义`, 'warning');
                    return;
                }
                
                for (const atomDef of group.atoms) {
                    const atomX = x + atomDef.x;
                    const atomY = y + atomDef.y;
                    const distanceCheck = checkAtomDistance(atomX, atomY, 35);
                    if (distanceCheck.tooClose) {
                        showNotification(`无法添加官能团：位置太靠近其他原子`, 'warning');
                        return;
                    }
                }
                
                const addedAtomIds = [];
                
                group.atoms.forEach((atomDef, index) => {
                    const atomX = x + atomDef.x;
                    const atomY = y + atomDef.y;
                    const atom = addAtom(atomDef.type, atomX, atomY);
                    if (atom) {
                        addedAtomIds.push(atom.id);
                    }
                });
                
                group.bonds.forEach(bondDef => {
                    const atom1Id = addedAtomIds[bondDef.atom1Index];
                    const atom2Id = addedAtomIds[bondDef.atom2Index];
                    if (atom1Id && atom2Id) {
                        addBond(atom1Id, atom2Id, bondDef.type);
                    }
                });
                
                showNotification(`已添加${group.name}官能团`, 'success');
            }
            
            // 加载示例 - 修复版，解决所有问题
            function loadExample(example) {
                clearAll();
                const centerX = 0;
                const centerY = 0;
                
                if (example === 'methane') {
                    // 甲烷
                    const c1 = addAtom('C', centerX, centerY);
                    const h1 = addAtom('H', centerX - 80, centerY);
                    const h2 = addAtom('H', centerX + 80, centerY);
                    const h3 = addAtom('H', centerX, centerY - 80);
                    const h4 = addAtom('H', centerX, centerY + 80);
                    
                    addBond(c1.id, h1.id, 'single');
                    addBond(c1.id, h2.id, 'single');
                    addBond(c1.id, h3.id, 'single');
                    addBond(c1.id, h4.id, 'single');
                    
                    showNotification('已加载甲烷示例', 'success');
                } else if (example === 'ethane') {
                    // 乙烷
                    const c1 = addAtom('C', centerX - 60, centerY);
                    const c2 = addAtom('C', centerX + 60, centerY);
                    const h1 = addAtom('H', centerX - 100, centerY - 50);
                    const h2 = addAtom('H', centerX - 100, centerY + 50);
                    const h3 = addAtom('H', centerX - 30, centerY - 90);
                    const h4 = addAtom('H', centerX - 30, centerY + 90);
                    const h5 = addAtom('H', centerX + 30, centerY - 90);
                    const h6 = addAtom('H', centerX + 30, centerY + 90);
                    const h7 = addAtom('H', centerX + 100, centerY - 50);
                    const h8 = addAtom('H', centerX + 100, centerY + 50);
                    
                    addBond(c1.id, c2.id, 'single');
                    addBond(c1.id, h1.id, 'single');
                    addBond(c1.id, h2.id, 'single');
                    addBond(c1.id, h3.id, 'single');
                    addBond(c1.id, h4.id, 'single');
                    addBond(c2.id, h5.id, 'single');
                    addBond(c2.id, h6.id, 'single');
                    addBond(c2.id, h7.id, 'single');
                    addBond(c2.id, h8.id, 'single');
                    
                    showNotification('已加载乙烷示例', 'success');
                } else if (example === 'ethene') {
                    // 乙烯
                    const c1 = addAtom('C', centerX - 60, centerY);
                    const c2 = addAtom('C', centerX + 60, centerY);
                    const h1 = addAtom('H', centerX - 100, centerY - 70);
                    const h2 = addAtom('H', centerX - 100, centerY + 70);
                    const h3 = addAtom('H', centerX + 100, centerY - 70);
                    const h4 = addAtom('H', centerX + 100, centerY + 70);
                    
                    addBond(c1.id, c2.id, 'double');
                    addBond(c1.id, h1.id, 'single');
                    addBond(c1.id, h2.id, 'single');
                    addBond(c2.id, h3.id, 'single');
                    addBond(c2.id, h4.id, 'single');
                    
                    showNotification('已加载乙烯示例', 'success');
                } else if (example === 'ethanol') {
                    // 乙醇
                    const c1 = addAtom('C', centerX - 80, centerY);
                    const c2 = addAtom('C', centerX + 30, centerY);
                    const o1 = addAtom('O', centerX + 110, centerY);
                    const h1 = addAtom('H', centerX - 140, centerY - 50);
                    const h2 = addAtom('H', centerX - 140, centerY + 50);
                    const h3 = addAtom('H', centerX - 50, centerY - 90);
                    const h4 = addAtom('H', centerX - 50, centerY + 90);
                    const h5 = addAtom('H', centerX + 30, centerY - 90);
                    const h6 = addAtom('H', centerX + 110, centerY + 90);
                    
                    addBond(c1.id, c2.id, 'single');
                    addBond(c2.id, o1.id, 'single');
                    addBond(c1.id, h1.id, 'single');
                    addBond(c1.id, h2.id, 'single');
                    addBond(c1.id, h3.id, 'single');
                    addBond(c2.id, h4.id, 'single');
                    addBond(c2.id, h5.id, 'single');
                    addBond(o1.id, h6.id, 'single');
                    
                    showNotification('已加载乙醇示例', 'success');
                } else if (example === 'benzene') {
                    // 苯环
                    const c1 = addAtom('C', centerX, centerY - 80);
                    const c2 = addAtom('C', centerX + 70, centerY - 40);
                    const c3 = addAtom('C', centerX + 70, centerY + 40);
                    const c4 = addAtom('C', centerX, centerY + 80);
                    const c5 = addAtom('C', centerX - 70, centerY + 40);
                    const c6 = addAtom('C', centerX - 70, centerY - 40);
                    const h1 = addAtom('H', centerX, centerY - 140);
                    const h2 = addAtom('H', centerX + 140, centerY - 40);
                    const h3 = addAtom('H', centerX + 140, centerY + 40);
                    const h4 = addAtom('H', centerX, centerY + 140);
                    const h5 = addAtom('H', centerX - 140, centerY + 40);
                    const h6 = addAtom('H', centerX - 140, centerY - 40);
                    
                    // 苯环键：交替单双键
                    addBond(c1.id, c2.id, 'single');
                    addBond(c2.id, c3.id, 'double');
                    addBond(c3.id, c4.id, 'single');
                    addBond(c4.id, c5.id, 'double');
                    addBond(c5.id, c6.id, 'single');
                    addBond(c6.id, c1.id, 'double');
                    
                    addBond(c1.id, h1.id, 'single');
                    addBond(c2.id, h2.id, 'single');
                    addBond(c3.id, h3.id, 'single');
                    addBond(c4.id, h4.id, 'single');
                    addBond(c5.id, h5.id, 'single');
                    addBond(c6.id, h6.id, 'single');
                    
                    showNotification('已加载苯环示例', 'success');
                } else if (example === 'toluene') {
                    // 甲苯
                    loadExample('benzene');
                    
                    const methylC = addAtom('C', centerX, centerY + 150);
                    const h1 = addAtom('H', centerX - 40, centerY + 180);
                    const h2 = addAtom('H', centerX + 40, centerY + 180);
                    const h3 = addAtom('H', centerX, centerY + 210);
                    
                    addBond(methylC.id, h1.id, 'single');
                    addBond(methylC.id, h2.id, 'single');
                    addBond(methylC.id, h3.id, 'single');
                    
                    const carbonAtoms = atoms.filter(atom => atom.type === 'C');
                    if (carbonAtoms.length > 6) {
                        // 连接到苯环的4号碳
                        const benzeneCarbons = carbonAtoms.slice(0, 6);
                        addBond(benzeneCarbons[3].id, methylC.id, 'single');
                    }
                    
                    showNotification('已加载甲苯示例', 'success');
                } else if (example === 'tnt') {
                    // TNT - 修复版，解决价键问题
                    clearAll();
                    
                    // 苯环碳原子
                    const c1 = addAtom('C', centerX, centerY - 100);
                    const c2 = addAtom('C', centerX + 90, centerY - 50);
                    const c3 = addAtom('C', centerX + 90, centerY + 50);
                    const c4 = addAtom('C', centerX, centerY + 100);
                    const c5 = addAtom('C', centerX - 90, centerY + 50);
                    const c6 = addAtom('C', centerX - 90, centerY - 50);
                    
                    // 苯环氢原子（除了2,4,6位）
                    const h1 = addAtom('H', centerX, centerY - 160);  // 1位
                    const h3 = addAtom('H', centerX + 180, centerY + 50); // 3位
                    const h5 = addAtom('H', centerX - 180, centerY + 50); // 5位
                    
                    // 甲基
                    const methylC = addAtom('C', centerX, centerY + 170);
                    const h7 = addAtom('H', centerX - 50, centerY + 200);
                    const h8 = addAtom('H', centerX + 50, centerY + 200);
                    const h9 = addAtom('H', centerX, centerY + 230);
                    
                    // 硝基 - 2位（修复：一个双键一个单键）
                    const n1 = addAtom('N', centerX + 180, centerY - 50);
                    const o1 = addAtom('O', centerX + 250, centerY - 80);  // 双键氧
                    const o2 = addAtom('O', centerX + 250, centerY - 20);  // 单键氧
                    
                    // 硝基 - 4位
                    const n2 = addAtom('N', centerX, centerY + 140);
                    const o3 = addAtom('O', centerX - 80, centerY + 140);  // 双键氧
                    const o4 = addAtom('O', centerX + 80, centerY + 140);  // 单键氧
                    
                    // 硝基 - 6位
                    const n3 = addAtom('N', centerX - 180, centerY - 50);
                    const o5 = addAtom('O', centerX - 250, centerY - 80);  // 双键氧
                    const o6 = addAtom('O', centerX - 250, centerY - 20);  // 单键氧
                    
                    // 苯环键
                    addBond(c1.id, c2.id, 'single');
                    addBond(c2.id, c3.id, 'double');
                    addBond(c3.id, c4.id, 'single');
                    addBond(c4.id, c5.id, 'double');
                    addBond(c5.id, c6.id, 'single');
                    addBond(c6.id, c1.id, 'double');
                    
                    // 氢键
                    addBond(c1.id, h1.id, 'single');
                    addBond(c3.id, h3.id, 'single');
                    addBond(c5.id, h5.id, 'single');
                    
                    // 甲基键
                    addBond(c4.id, methylC.id, 'single');
                    addBond(methylC.id, h7.id, 'single');
                    addBond(methylC.id, h8.id, 'single');
                    addBond(methylC.id, h9.id, 'single');
                    
                    // 硝基键 - 2位（一个双键，一个单键）
                    addBond(c2.id, n1.id, 'single');
                    addBond(n1.id, o1.id, 'double');
                    addBond(n1.id, o2.id, 'single');  // 改为单键，解决价键问题
                    
                    // 硝基键 - 4位（一个双键，一个单键）
                    addBond(c4.id, n2.id, 'single');
                    addBond(n2.id, o3.id, 'double');
                    addBond(n2.id, o4.id, 'single');  // 改为单键，解决价键问题
                    
                    // 硝基键 - 6位（一个双键，一个单键）
                    addBond(c6.id, n3.id, 'single');
                    addBond(n3.id, o5.id, 'double');
                    addBond(n3.id, o6.id, 'single');  // 改为单键，解决价键问题
                    
                    showNotification('已加载2,4,6-三硝基甲苯(TNT)示例', 'success');
                } else if (example === 'acetic_acid') {
                    // 乙酸
                    const c1 = addAtom('C', centerX - 80, centerY);
                    const h1 = addAtom('H', centerX - 140, centerY - 50);
                    const h2 = addAtom('H', centerX - 140, centerY + 50);
                    const h3 = addAtom('H', centerX - 80, centerY - 90);
                    
                    const c2 = addAtom('C', centerX, centerY);
                    
                    const o1 = addAtom('O', centerX + 60, centerY - 40);
                    const o2 = addAtom('O', centerX + 60, centerY + 40);
                    const h4 = addAtom('H', centerX + 120, centerY + 40);
                    
                    addBond(c1.id, c2.id, 'single');
                    addBond(c1.id, h1.id, 'single');
                    addBond(c1.id, h2.id, 'single');
                    addBond(c1.id, h3.id, 'single');
                    
                    addBond(c2.id, o1.id, 'double');
                    addBond(c2.id, o2.id, 'single');
                    addBond(o2.id, h4.id, 'single');
                    
                    showNotification('已加载乙酸示例', 'success');
                } else if (example === 'cyclobutane') {
                    // 环丁烷
                    const c1 = addAtom('C', centerX, centerY - 100);
                    const c2 = addAtom('C', centerX + 100, centerY);
                    const c3 = addAtom('C', centerX, centerY + 100);
                    const c4 = addAtom('C', centerX - 100, centerY);
                    
                    const h1 = addAtom('H', centerX, centerY - 170);
                    const h2 = addAtom('H', centerX + 70, centerY - 70);
                    const h3 = addAtom('H', centerX + 170, centerY);
                    const h4 = addAtom('H', centerX + 70, centerY + 70);
                    const h5 = addAtom('H', centerX, centerY + 170);
                    const h6 = addAtom('H', centerX - 70, centerY + 70);
                    const h7 = addAtom('H', centerX - 170, centerY);
                    const h8 = addAtom('H', centerX - 70, centerY - 70);
                    
                    addBond(c1.id, c2.id, 'single');
                    addBond(c2.id, c3.id, 'single');
                    addBond(c3.id, c4.id, 'single');
                    addBond(c4.id, c1.id, 'single');
                    
                    addBond(c1.id, h1.id, 'single');
                    addBond(c1.id, h2.id, 'single');
                    addBond(c2.id, h3.id, 'single');
                    addBond(c2.id, h4.id, 'single');
                    addBond(c3.id, h5.id, 'single');
                    addBond(c3.id, h6.id, 'single');
                    addBond(c4.id, h7.id, 'single');
                    addBond(c4.id, h8.id, 'single');
                    
                    showNotification('已加载环丁烷示例', 'success');
                } else if (example === 'cyclohexane') {
                    // 环己烷 - 修复版，确保没有双键
                    const c1 = addAtom('C', centerX, centerY - 120);
                    const c2 = addAtom('C', centerX + 104, centerY - 60);
                    const c3 = addAtom('C', centerX + 104, centerY + 60);
                    const c4 = addAtom('C', centerX, centerY + 120);
                    const c5 = addAtom('C', centerX - 104, centerY + 60);
                    const c6 = addAtom('C', centerX - 104, centerY - 60);
                    
                    const h1 = addAtom('H', centerX, centerY - 190);
                    const h2 = addAtom('H', centerX + 70, centerY - 150);
                    const h3 = addAtom('H', centerX + 180, centerY - 30);
                    const h4 = addAtom('H', centerX + 180, centerY + 30);
                    const h5 = addAtom('H', centerX + 70, centerY + 150);
                    const h6 = addAtom('H', centerX, centerY + 190);
                    const h7 = addAtom('H', centerX - 70, centerY + 150);
                    const h8 = addAtom('H', centerX - 180, centerY + 30);
                    const h9 = addAtom('H', centerX - 180, centerY - 30);
                    const h10 = addAtom('H', centerX - 70, centerY - 150);
                    const h11 = addAtom('H', centerX - 30, centerY - 90);
                    const h12 = addAtom('H', centerX + 30, centerY - 90);
                    
                    // 环己烷只有单键
                    addBond(c1.id, c2.id, 'single');
                    addBond(c2.id, c3.id, 'single');
                    addBond(c3.id, c4.id, 'single');
                    addBond(c4.id, c5.id, 'single');
                    addBond(c5.id, c6.id, 'single');
                    addBond(c6.id, c1.id, 'single');
                    
                    addBond(c1.id, h1.id, 'single');
                    addBond(c1.id, h11.id, 'single');
                    addBond(c2.id, h2.id, 'single');
                    addBond(c2.id, h12.id, 'single');
                    addBond(c3.id, h3.id, 'single');
                    addBond(c3.id, h4.id, 'single');
                    addBond(c4.id, h5.id, 'single');
                    addBond(c4.id, h6.id, 'single');
                    addBond(c5.id, h7.id, 'single');
                    addBond(c5.id, h8.id, 'single');
                    addBond(c6.id, h9.id, 'single');
                    addBond(c6.id, h10.id, 'single');
                    
                    showNotification('已加载环己烷示例', 'success');
                } else if (example === 'c2f2br2') {
                    // C2F2Br2 - 1,2-二溴-1,2-二氟乙烯
                    const c1 = addAtom('C', centerX - 60, centerY);
                    const c2 = addAtom('C', centerX + 60, centerY);
                    const f1 = addAtom('F', centerX - 120, centerY);
                    const f2 = addAtom('F', centerX + 120, centerY);
                    const br1 = addAtom('Br', centerX - 60, centerY - 100);
                    const br2 = addAtom('Br', centerX + 60, centerY - 100);
                    
                    addBond(c1.id, c2.id, 'double');
                    addBond(c1.id, f1.id, 'single');
                    addBond(c1.id, br1.id, 'single');
                    addBond(c2.id, f2.id, 'single');
                    addBond(c2.id, br2.id, 'single');
                    
                    showNotification('已加载1,2-二溴-1,2-二氟乙烯(C₂F₂Br₂)示例', 'success');
                } else if (example === 'acetylene') {
                    // 乙炔
                    const c1 = addAtom('C', centerX - 60, centerY);
                    const c2 = addAtom('C', centerX + 60, centerY);
                    const h1 = addAtom('H', centerX - 120, centerY);
                    const h2 = addAtom('H', centerX + 120, centerY);
                    
                    addBond(c1.id, c2.id, 'triple');
                    addBond(c1.id, h1.id, 'single');
                    addBond(c2.id, h2.id, 'single');
                    
                    showNotification('已加载乙炔示例', 'success');
                } else if (example === 'propene') {
                    // 丙烯
                    const c1 = addAtom('C', centerX - 80, centerY);
                    const c2 = addAtom('C', centerX, centerY);
                    const c3 = addAtom('C', centerX + 80, centerY);
                    const h1 = addAtom('H', centerX - 120, centerY - 70);
                    const h2 = addAtom('H', centerX - 120, centerY + 70);
                    const h3 = addAtom('H', centerX - 40, centerY - 90);
                    const h4 = addAtom('H', centerX + 40, centerY - 90);
                    const h5 = addAtom('H', centerX + 120, centerY - 70);
                    const h6 = addAtom('H', centerX + 120, centerY + 70);
                    
                    addBond(c1.id, c2.id, 'double');
                    addBond(c2.id, c3.id, 'single');
                    addBond(c1.id, h1.id, 'single');
                    addBond(c1.id, h2.id, 'single');
                    addBond(c2.id, h3.id, 'single');
                    addBond(c2.id, h4.id, 'single');
                    addBond(c3.id, h5.id, 'single');
                    addBond(c3.id, h6.id, 'single');
                    
                    showNotification('已加载丙烯示例', 'success');
                } else if (example === 'hydroxypropene') {
                    // 2-羟基丙烯
                    const c1 = addAtom('C', centerX - 80, centerY);
                    const c2 = addAtom('C', centerX, centerY);
                    const c3 = addAtom('C', centerX + 80, centerY);
                    const o1 = addAtom('O', centerX, centerY + 80);  // 羟基氧
                    const h1 = addAtom('H', centerX - 120, centerY - 70);
                    const h2 = addAtom('H', centerX - 120, centerY + 70);
                    const h3 = addAtom('H', centerX - 40, centerY - 90);
                    const h4 = addAtom('H', centerX + 40, centerY - 90);
                    const h5 = addAtom('H', centerX + 120, centerY - 70);
                    const h6 = addAtom('H', centerX + 120, centerY + 70);
                    const h7 = addAtom('H', centerX, centerY + 120);  // 羟基氢
                    
                    addBond(c1.id, c2.id, 'double');
                    addBond(c2.id, c3.id, 'single');
                    addBond(c2.id, o1.id, 'single');  // 羟基连接到中间碳
                    addBond(o1.id, h7.id, 'single');
                    
                    addBond(c1.id, h1.id, 'single');
                    addBond(c1.id, h2.id, 'single');
                    addBond(c2.id, h3.id, 'single');
                    addBond(c2.id, h4.id, 'single');
                    addBond(c3.id, h5.id, 'single');
                    addBond(c3.id, h6.id, 'single');
                    
                    showNotification('已加载2-羟基丙烯示例', 'success');
                } else {
                    showNotification(`示例 ${example} 未定义`, 'warning');
                }
                
                updateInfo();
                resetView();
            }
            
            // 更新光标信息
            function updateCursorInfo() {
                const container = document.getElementById('canvas-container');
                
                container.className = 'canvas-container';
                if (currentMode === 'add') {
                    cursorInfo.textContent = `点击空白处添加${atomProperties[selectedAtomType].name}原子`;
                    modeIndicator.textContent = `模式：添加原子 (${atomProperties[selectedAtomType].name})`;
                    container.classList.add('add-mode');
                } else if (currentMode === 'connect') {
                    if (selectedAtom) {
                        cursorInfo.textContent = `已选择${selectedAtom.properties.name}原子，点击其他原子连接${bondProperties[selectedBondType].name}`;
                        modeIndicator.textContent = `模式：连接原子 (${bondProperties[selectedBondType].name})`;
                    } else {
                        cursorInfo.textContent = `点击一个原子选择它，然后点击另一个原子连接${bondProperties[selectedBondType].name}`;
                        modeIndicator.textContent = `模式：连接原子 (${bondProperties[selectedBondType].name})`;
                    }
                    container.classList.add('connect-mode');
                } else if (currentMode === 'delete') {
                    cursorInfo.textContent = '点击原子删除它及其连接的化学键';
                    modeIndicator.textContent = '模式：删除原子';
                    container.classList.add('delete-mode');
                } else if (currentMode === 'drag') {
                    cursorInfo.textContent = '拖拽原子或空白处移动视图';
                    modeIndicator.textContent = '模式：拖拽';
                    container.classList.add('dragging');
                }
            }
            
            // 更新原子属性显示
            function updateAtomProperties(atomType) {
                const props = atomProperties[atomType];
                if (!props) return;
                
                document.getElementById('atom-valence').textContent = props.valence;
                document.getElementById('atom-mass').textContent = props.mass;
                document.getElementById('atom-electronegativity').textContent = props.electronegativity;
            }
            
            // 旋转分子
            function rotateMolecule() {
                isRotating = !isRotating;
                const rotateBtn = document.getElementById('rotate-btn');
                
                if (isRotating) {
                    rotateBtn.innerHTML = '<i class="fas fa-stop"></i> 停止';
                    startRotation();
                } else {
                    rotateBtn.innerHTML = '<i class="fas fa-sync-alt"></i> 旋转';
                }
            }
            
            // 开始旋转动画
            function startRotation() {
                if (!isRotating) return;
                
                moleculeRotation += 1;
                if (moleculeRotation >= 360) moleculeRotation = 0;
                
                drawAll();
                
                requestAnimationFrame(startRotation);
            }
            
            // 导出分子信息
            function exportMolecule() {
                if (atoms.length === 0) {
                    showNotification('没有分子可以导出', 'warning');
                    return;
                }
                
                const atomCounts = {};
                atoms.forEach(atom => {
                    atomCounts[atom.type] = (atomCounts[atom.type] || 0) + 1;
                });
                
                const formula = Object.keys(atomCounts)
                    .map(el => el + (atomCounts[el] > 1 ? atomCounts[el] : ''))
                    .join('');
                
                let exportText = `有机化合物信息\n`;
                exportText += `====================\n`;
                exportText += `名称: ${document.getElementById('compound-name').textContent}\n`;
                exportText += `分子式: ${formula}\n`;
                exportText += `分子量: ${document.getElementById('molecular-weight').textContent}\n`;
                exportText += `原子总数: ${atoms.length}\n`;
                exportText += `化学键总数: ${bonds.length}\n`;
                exportText += `====================\n`;
                
                const blob = new Blob([exportText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = '分子信息.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('分子信息已导出', 'success');
            }
            
            // 显示提示
            function showHint() {
                const hints = [
                    "提示：碳原子可以形成4个化学键，氢原子只能形成1个",
                    "提示：使用不同化学键类型构建双键、三键等结构",
                    "提示：切换操作模式可以添加原子、连接原子或删除原子",
                    "提示：点击官能团可以快速添加复杂的分子结构",
                    "提示：尝试构建2,4,6-三硝基甲苯等复杂化合物",
                    "提示：环状化合物命名时会自动识别为环烷烃或环烯烃",
                    "提示：苯环结构会被自动识别并正确命名",
                    "提示：使用鼠标滚轮或缩放按钮调整视图大小",
                    "提示：在拖拽模式下，可以拖动原子或整个画布"
                ];
                
                const randomHint = hints[Math.floor(Math.random() * hints.length)];
                showNotification(randomHint, 'info');
            }
            
            // 随机示例
            function randomExample() {
                const examples = ['methane', 'ethane', 'ethene', 'ethanol', 'benzene', 'toluene', 'tnt', 'acetic_acid', 'cyclobutane', 'cyclohexane', 'c2f2br2', 'acetylene', 'propene', 'hydroxypropene'];
                const randomExample = examples[Math.floor(Math.random() * examples.length)];
                loadExample(randomExample);
            }
            
            // 初始化事件监听器
            function initEventListeners() {
                // 原子选择
                document.querySelectorAll('.atom-item').forEach(item => {
                    item.addEventListener('click', () => {
                        selectedAtomType = item.dataset.atom;
                        document.querySelectorAll('.atom-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                        updateAtomProperties(selectedAtomType);
                        updateCursorInfo();
                    });
                });
                
                // 化学键选择
                document.querySelectorAll('.bond-item').forEach(item => {
                    item.addEventListener('click', () => {
                        selectedBondType = item.dataset.bond;
                        document.querySelectorAll('.bond-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                    });
                });
                
                // 操作模式按钮
                document.getElementById('add-atom-btn').addEventListener('click', function() {
                    currentMode = 'add';
                    selectedAtom = null;
                    document.querySelectorAll('.action-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    updateCursorInfo();
                });
                
                document.getElementById('connect-atoms-btn').addEventListener('click', function() {
                    currentMode = 'connect';
                    selectedAtom = null;
                    document.querySelectorAll('.action-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    updateCursorInfo();
                });
                
                document.getElementById('delete-btn').addEventListener('click', function() {
                    currentMode = 'delete';
                    selectedAtom = null;
                    document.querySelectorAll('.action-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    updateCursorInfo();
                });
                
                document.getElementById('drag-btn').addEventListener('click', function() {
                    currentMode = 'drag';
                    selectedAtom = null;
                    document.querySelectorAll('.action-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    updateCursorInfo();
                });
                
                // 官能团点击
                document.querySelectorAll('.functional-item').forEach(funcElement => {
                    funcElement.addEventListener('click', function() {
                        const groupId = this.dataset.functional;
                        
                        // 在画布中央添加官能团
                        const centerX = 0;
                        const centerY = 0;
                        
                        addFunctionalGroup(groupId, centerX - 80, centerY);
                    });
                });
                
                // 示例点击
                document.querySelectorAll('.example-item').forEach(item => {
                    item.addEventListener('click', () => {
                        loadExample(item.dataset.example);
                    });
                });
                
                // 控制按钮
                document.getElementById('name-btn').addEventListener('click', generateCompoundInfo);
                document.getElementById('clear-btn').addEventListener('click', clearAll);
                document.getElementById('hint-btn').addEventListener('click', showHint);
                document.getElementById('export-btn').addEventListener('click', exportMolecule);
                document.getElementById('rotate-btn').addEventListener('click', rotateMolecule);
                document.getElementById('random-btn').addEventListener('click', randomExample);
                document.getElementById('reset-view-btn').addEventListener('click', resetView);
                
                // 缩放按钮
                document.getElementById('zoom-in-btn').addEventListener('click', function() {
                    const rect = canvas.getBoundingClientRect();
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    zoomAtPoint(1, centerX, centerY);
                });
                
                document.getElementById('zoom-out-btn').addEventListener('click', function() {
                    const rect = canvas.getBoundingClientRect();
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    zoomAtPoint(-1, centerX, centerY);
                });
                
                document.getElementById('zoom-reset-btn').addEventListener('click', resetView);
                
                // Canvas鼠标事件
                canvas.addEventListener('mousedown', (event) => {
                    event.preventDefault();
                    
                    const rect = canvas.getBoundingClientRect();
                    const x = event.clientX - rect.left;
                    const y = event.clientY - rect.top;
                    
                    let clickedAtom = null;
                    for (let i = atoms.length - 1; i >= 0; i--) {
                        if (atoms[i].isClicked(x, y)) {
                            clickedAtom = atoms[i];
                            break;
                        }
                    }
                    
                    if (currentMode === 'drag') {
                        isDragging = true;
                        isDraggingAtom = clickedAtom !== null;
                        dragStartX = x;
                        dragStartY = y;
                        
                        if (isDraggingAtom) {
                            initialAtomPositions = atoms.map(atom => ({ x: atom.x, y: atom.y }));
                            clickedAtom.isDragging = true;
                        }
                        
                        canvasContainer.classList.add('dragging');
                    } else if (clickedAtom) {
                        if (currentMode === 'connect') {
                            if (selectedAtom && selectedAtom.id !== clickedAtom.id) {
                                addBond(selectedAtom.id, clickedAtom.id, selectedBondType);
                                selectedAtom = null;
                            } else {
                                selectedAtom = clickedAtom;
                            }
                        } else if (currentMode === 'delete') {
                            const index = atoms.indexOf(clickedAtom);
                            if (index > -1) {
                                const bondsToRemove = bonds.filter(bond => 
                                    bond.atom1Id === clickedAtom.id || bond.atom2Id === clickedAtom.id
                                );
                                bondsToRemove.forEach(bond => {
                                    const bondIndex = bonds.indexOf(bond);
                                    if (bondIndex > -1) {
                                        bonds.splice(bondIndex, 1);
                                    }
                                });
                                atoms.splice(index, 1);
                                if (selectedAtom === clickedAtom) {
                                    selectedAtom = null;
                                }
                                updateInfo();
                                showNotification('原子已删除', 'info');
                            }
                        } else {
                            selectedAtom = clickedAtom;
                        }
                    } else {
                        if (currentMode === 'add') {
                            const worldPos = screenToWorld(x, y);
                            addAtom(selectedAtomType, worldPos.x, worldPos.y);
                        } else if (currentMode === 'connect') {
                            selectedAtom = null;
                        }
                    }
                    
                    updateCursorInfo();
                    drawAll();
                });
                
                canvas.addEventListener('mousemove', (event) => {
                    event.preventDefault();
                    
                    const rect = canvas.getBoundingClientRect();
                    const x = event.clientX - rect.left;
                    const y = event.clientY - rect.top;
                    
                    if (isDragging) {
                        const deltaX = x - dragStartX;
                        const deltaY = y - dragStartY;
                        
                        if (isDraggingAtom) {
                            const worldDeltaX = deltaX / scale;
                            const worldDeltaY = deltaY / scale;
                            
                            atoms.forEach((atom, index) => {
                                if (atom.isDragging) {
                                    atom.moveTo(
                                        initialAtomPositions[index].x + worldDeltaX,
                                        initialAtomPositions[index].y + worldDeltaY
                                    );
                                }
                            });
                        } else {
                            offsetX += deltaX;
                            offsetY += deltaY;
                            dragStartX = x;
                            dragStartY = y;
                        }
                        
                        drawAll();
                    }
                });
                
                canvas.addEventListener('mouseup', (event) => {
                    event.preventDefault();
                    
                    if (isDragging) {
                        isDragging = false;
                        
                        if (isDraggingAtom) {
                            atoms.forEach(atom => {
                                atom.isDragging = false;
                            });
                            isDraggingAtom = false;
                        }
                        
                        canvasContainer.classList.remove('dragging');
                        drawAll();
                    }
                });
                
                canvas.addEventListener('mouseleave', () => {
                    if (isDragging) {
                        isDragging = false;
                        
                        if (isDraggingAtom) {
                            atoms.forEach(atom => {
                                atom.isDragging = false;
                            });
                            isDraggingAtom = false;
                        }
                        
                        canvasContainer.classList.remove('dragging');
                        drawAll();
                    }
                });
                
                // 鼠标滚轮缩放
                canvas.addEventListener('wheel', (event) => {
                    event.preventDefault();
                    
                    const rect = canvas.getBoundingClientRect();
                    const x = event.clientX - rect.left;
                    const y = event.clientY - rect.top;
                    
                    const delta = event.deltaY > 0 ? -1 : 1;
                    zoomAtPoint(delta, x, y);
                }, { passive: false });
                
                // 触摸事件支持
                let touchStartDistance = 0;
                let touchStartScale = 1;
                let touchStartOffsetX = 0;
                let touchStartOffsetY = 0;
                let touchStartX1 = 0;
                let touchStartY1 = 0;
                let touchStartX2 = 0;
                let touchStartY2 = 0;
                
                canvas.addEventListener('touchstart', (event) => {
                    event.preventDefault();
                    
                    if (event.touches.length === 1) {
                        const rect = canvas.getBoundingClientRect();
                        const touch = event.touches[0];
                        const x = touch.clientX - rect.left;
                        const y = touch.clientY - rect.top;
                        
                        let touchedAtom = null;
                        for (let i = atoms.length - 1; i >= 0; i--) {
                            if (atoms[i].isClicked(x, y)) {
                                touchedAtom = atoms[i];
                                break;
                            }
                        }
                        
                        if (currentMode === 'drag') {
                            isDragging = true;
                            isDraggingAtom = touchedAtom !== null;
                            dragStartX = x;
                            dragStartY = y;
                            
                            if (isDraggingAtom) {
                                initialAtomPositions = atoms.map(atom => ({ x: atom.x, y: atom.y }));
                                touchedAtom.isDragging = true;
                            }
                        } else if (touchedAtom) {
                            if (currentMode === 'connect') {
                                if (selectedAtom && selectedAtom.id !== touchedAtom.id) {
                                    addBond(selectedAtom.id, touchedAtom.id, selectedBondType);
                                    selectedAtom = null;
                                } else {
                                    selectedAtom = touchedAtom;
                                }
                            } else if (currentMode === 'delete') {
                                const index = atoms.indexOf(touchedAtom);
                                if (index > -1) {
                                    const bondsToRemove = bonds.filter(bond => 
                                        bond.atom1Id === touchedAtom.id || bond.atom2Id === touchedAtom.id
                                    );
                                    bondsToRemove.forEach(bond => {
                                        const bondIndex = bonds.indexOf(bond);
                                        if (bondIndex > -1) {
                                            bonds.splice(bondIndex, 1);
                                        }
                                    });
                                    atoms.splice(index, 1);
                                    if (selectedAtom === touchedAtom) {
                                        selectedAtom = null;
                                    }
                                    updateInfo();
                                    showNotification('原子已删除', 'info');
                                }
                            } else if (currentMode === 'add') {
                                selectedAtom = touchedAtom;
                            }
                        } else {
                            if (currentMode === 'add') {
                                const worldPos = screenToWorld(x, y);
                                addAtom(selectedAtomType, worldPos.x, worldPos.y);
                            } else if (currentMode === 'connect') {
                                selectedAtom = null;
                            }
                        }
                        
                        updateCursorInfo();
                        drawAll();
                    } else if (event.touches.length === 2) {
                        const rect = canvas.getBoundingClientRect();
                        const touch1 = event.touches[0];
                        const touch2 = event.touches[1];
                        
                        touchStartX1 = touch1.clientX - rect.left;
                        touchStartY1 = touch1.clientY - rect.top;
                        touchStartX2 = touch2.clientX - rect.left;
                        touchStartY2 = touch2.clientY - rect.top;
                        
                        touchStartDistance = Math.sqrt(
                            Math.pow(touchStartX2 - touchStartX1, 2) + 
                            Math.pow(touchStartY2 - touchStartY1, 2)
                        );
                        touchStartScale = scale;
                        touchStartOffsetX = offsetX;
                        touchStartOffsetY = offsetY;
                    }
                }, { passive: false });
                
                canvas.addEventListener('touchmove', (event) => {
                    event.preventDefault();
                    
                    if (event.touches.length === 1 && isDragging) {
                        const rect = canvas.getBoundingClientRect();
                        const touch = event.touches[0];
                        const x = touch.clientX - rect.left;
                        const y = touch.clientY - rect.top;
                        
                        const deltaX = x - dragStartX;
                        const deltaY = y - dragStartY;
                        
                        if (isDraggingAtom) {
                            const worldDeltaX = deltaX / scale;
                            const worldDeltaY = deltaY / scale;
                            
                            atoms.forEach((atom, index) => {
                                if (atom.isDragging) {
                                    atom.moveTo(
                                        initialAtomPositions[index].x + worldDeltaX,
                                        initialAtomPositions[index].y + worldDeltaY
                                    );
                                }
                            });
                        } else {
                            offsetX += deltaX;
                            offsetY += deltaY;
                            dragStartX = x;
                            dragStartY = y;
                        }
                        
                        drawAll();
                    } else if (event.touches.length === 2) {
                        const rect = canvas.getBoundingClientRect();
                        const touch1 = event.touches[0];
                        const touch2 = event.touches[1];
                        
                        const touchX1 = touch1.clientX - rect.left;
                        const touchY1 = touch1.clientY - rect.top;
                        const touchX2 = touch2.clientX - rect.left;
                        const touchY2 = touch2.clientY - rect.top;
                        
                        const touchDistance = Math.sqrt(
                            Math.pow(touchX2 - touchX1, 2) + 
                            Math.pow(touchY2 - touchY1, 2)
                        );
                        
                        if (touchStartDistance > 0) {
                            const scaleFactor = touchDistance / touchStartDistance;
                            const newScale = touchStartScale * scaleFactor;
                            
                            scale = Math.max(minScale, Math.min(maxScale, newScale));
                            
                            const centerX = (touchX1 + touchX2) / 2;
                            const centerY = (touchY1 + touchY2) / 2;
                            
                            const worldPos = screenToWorld(centerX, centerY);
                            offsetX = centerX - worldPos.x * scale;
                            offsetY = centerY - worldPos.y * scale;
                            
                            updateZoomDisplay();
                            drawAll();
                        }
                    }
                }, { passive: false });
                
                canvas.addEventListener('touchend', (event) => {
                    event.preventDefault();
                    
                    if (event.touches.length === 0) {
                        if (isDragging) {
                            isDragging = false;
                            
                            if (isDraggingAtom) {
                                atoms.forEach(atom => {
                                    atom.isDragging = false;
                                });
                                isDraggingAtom = false;
                            }
                            
                            canvasContainer.classList.remove('dragging');
                            drawAll();
                        }
                        
                        touchStartDistance = 0;
                    }
                }, { passive: false });
            }
            
            // 初始化
            function init() {
                resizeCanvas();
                initEventListeners();
                updateAtomProperties(selectedAtomType);
                updateCursorInfo();
                updateZoomDisplay();
                showNotification('欢迎使用全屏有机化合物拼图系统！', 'info');
            }
            
            // 页面加载完成后初始化
            window.addEventListener('load', init);
        });
    </script>
</body>
</html>
